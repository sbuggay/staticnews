<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1696842083411" as="style"/><link rel="stylesheet" href="styles.css?v=1696842083411"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://forum.level1techs.com/t/mitigations-off-considered-harmful-or-spurious-sigill-on-amd-zen4/202049">Mitigations=off considered harmful or spurious SIGILL on AMD Zen4</a> <span class="domain">(<a href="https://forum.level1techs.com">forum.level1techs.com</a>)</span></div><div class="subtext"><span>2bluesc</span> | <span>40 comments</span></div><br/><div><div id="37812577" class="c"><input type="checkbox" id="c-37812577" checked=""/><div class="controls bullet"><span class="by">2bluesc</span><span>|</span><a href="#37815850">next</a><span>|</span><label class="collapse" for="c-37812577">[-]</label><label class="expand" for="c-37812577">[16 more]</label></div><br/><div class="children"><div class="content">Interesting walk through in the linked video as he tried to troubleshoot this:<p><a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;live&#x2F;1UnoBfw6soI">https:&#x2F;&#x2F;www.youtube.com&#x2F;live&#x2F;1UnoBfw6soI</a><p>Pretty shocking to see (extremely unlikely) non-malicious code work &#x2F; not-work depending on a security mitigation setting.<p>Curious to see where this goes as to whether it&#x27;s a kernel bug and nobody is paying attention to `mitigations=off` now or the unlikely outcome that it&#x27;s an actual hardware bug where mitigations work around it and nobody has noticed.<p>Seems he had overclocked and maybe disabling the migation has revealed an instability in his setup that&#x27;s otherwise stable (or at best marginal).</div><br/><div id="37812944" class="c"><input type="checkbox" id="c-37812944" checked=""/><div class="controls bullet"><span class="by">yellow_lead</span><span>|</span><a href="#37812577">parent</a><span>|</span><a href="#37813029">next</a><span>|</span><label class="collapse" for="c-37812944">[-]</label><label class="expand" for="c-37812944">[1 more]</label></div><br/><div class="children"><div class="content">He says that he tried stock voltage for everything, and even undervolted&#x2F;underclocked CPU&#x2F;memory and still had the bug.</div><br/></div></div><div id="37813029" class="c"><input type="checkbox" id="c-37813029" checked=""/><div class="controls bullet"><span class="by">tux3</span><span>|</span><a href="#37812577">parent</a><span>|</span><a href="#37812944">prev</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37813029">[-]</label><label class="expand" for="c-37813029">[10 more]</label></div><br/><div class="children"><div class="content">mitigations=off does a lot of things, it&#x27;s a bundle of options<p>Perhaps the next step is trying to figure out which mitigation exactly causes it to fail. Then kernel peeps should have a fighting chance of tracking this down</div><br/><div id="37813637" class="c"><input type="checkbox" id="c-37813637" checked=""/><div class="controls bullet"><span class="by">simcop2387</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37813029">parent</a><span>|</span><a href="#37814226">next</a><span>|</span><label class="collapse" for="c-37813637">[-]</label><label class="expand" for="c-37813637">[1 more]</label></div><br/><div class="children"><div class="content">In the video comments it looks like he&#x27;s done some of that and it&#x27;s one of the spectre v2 mitigations.  Makes me wonder if there&#x27;s now less QA happening on the oem side without mitigations=on.</div><br/></div></div><div id="37814226" class="c"><input type="checkbox" id="c-37814226" checked=""/><div class="controls bullet"><span class="by">AnotherGoodName</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37813029">parent</a><span>|</span><a href="#37813637">prev</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37814226">[-]</label><label class="expand" for="c-37814226">[8 more]</label></div><br/><div class="children"><div class="content">SMT off fixing it is a good clue. It heavily points to the problem being within a core rather than between execution cores. That&#x27;s still a broad area though. Within a core some state is inadvertantly shared between the shared threads running on it but there&#x27;s a lot of possibilities of what that could be.</div><br/><div id="37814314" class="c"><input type="checkbox" id="c-37814314" checked=""/><div class="controls bullet"><span class="by">foota</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37814226">parent</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37814314">[-]</label><label class="expand" for="c-37814314">[7 more]</label></div><br/><div class="children"><div class="content">Some state being in the CPU or kernel? I guess if you have per core state in the kernel that&#x27;s only accessed by that core, then you&#x27;re safe to modify it without locking, but this isn&#x27;t the case for data shared between hyperthreads of a core?</div><br/><div id="37814720" class="c"><input type="checkbox" id="c-37814720" checked=""/><div class="controls bullet"><span class="by">AnotherGoodName</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37814314">parent</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37814720">[-]</label><label class="expand" for="c-37814720">[6 more]</label></div><br/><div class="children"><div class="content">Within the CPU core (terminology here gets awkward). Spectre in its simplest to exploit form used the fact that the branch prediction based state wasn&#x27;t completely cleared between running different threads on the CPU and led to a really easy timing attack. Time your own code to see which way the branch of the previous code likely went. There&#x27;s a lot of CVE&#x27;s around this but that&#x27;s the simplest case.<p>The mitigations work by making sure to clear everything they can when the CPU switches contexts. This includes clearing loaded local CPU cache, clearing the branch prediction table, clearing all speculative execution entries. The mitigations likely avoid a crash by clearing something that should be cleared between context switches in all cases. As in the mitigations likely accidentally fix this. Which is a good clue. It&#x27;d be nice if the mitigations were more fine grained than all or nothing so we could turn on the mitigations one by one but the microcode is not open so we can&#x27;t do this :(.</div><br/><div id="37815260" class="c"><input type="checkbox" id="c-37815260" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37814720">parent</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37815260">[-]</label><label class="expand" for="c-37815260">[5 more]</label></div><br/><div class="children"><div class="content">Is it likely the issue is within the Linux kernel itself or within the microcode for the CPU?</div><br/><div id="37815735" class="c"><input type="checkbox" id="c-37815735" checked=""/><div class="controls bullet"><span class="by">AnotherGoodName</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37815260">parent</a><span>|</span><a href="#37815379">prev</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37815735">[-]</label><label class="expand" for="c-37815735">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m going to say microcode until someone reproduces on a completely different architecture :).</div><br/><div id="37815883" class="c"><input type="checkbox" id="c-37815883" checked=""/><div class="controls bullet"><span class="by">jdiff</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37815735">parent</a><span>|</span><a href="#37815432">next</a><span>|</span><label class="collapse" for="c-37815883">[-]</label><label class="expand" for="c-37815883">[1 more]</label></div><br/><div class="children"><div class="content">A lot of these mitigations are joint efforts between the kernel and CPU, and the mitigations kernel parameter isn&#x27;t a binary on&#x2F;off, you can configure individual mitigations. It&#x27;s not a single flag that does signals the microcode to do spooky proprietary things.</div><br/></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div id="37815432" class="c"><input type="checkbox" id="c-37815432" checked=""/><div class="controls bullet"><span class="by">tyrfing</span><span>|</span><a href="#37812577">parent</a><span>|</span><a href="#37813029">prev</a><span>|</span><a href="#37815564">next</a><span>|</span><label class="collapse" for="c-37815432">[-]</label><label class="expand" for="c-37815432">[2 more]</label></div><br/><div class="children"><div class="content">Mitigations can have very large effects on system stability, I ran into this with my old Haswell system. Mitigations on allowed, I believe, 100Mhz higher at lower voltage - but it may have been 200Mhz. These settings were tested over many months, completely stable, and mitigations off with the same setting wouldn&#x27;t even allow booting. Huge effect relative to anything else, basically like adding an extra 0.1V vcore.</div><br/><div id="37817926" class="c"><input type="checkbox" id="c-37817926" checked=""/><div class="controls bullet"><span class="by">formerly_proven</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37815432">parent</a><span>|</span><a href="#37815564">next</a><span>|</span><label class="collapse" for="c-37817926">[-]</label><label class="expand" for="c-37817926">[1 more]</label></div><br/><div class="children"><div class="content">Yah, because Haswell gets a lot less stuff done with mitigations=on.</div><br/></div></div></div></div><div id="37815564" class="c"><input type="checkbox" id="c-37815564" checked=""/><div class="controls bullet"><span class="by">Levitating</span><span>|</span><a href="#37812577">parent</a><span>|</span><a href="#37815432">prev</a><span>|</span><a href="#37815850">next</a><span>|</span><label class="collapse" for="c-37815564">[-]</label><label class="expand" for="c-37815564">[2 more]</label></div><br/><div class="children"><div class="content">What does he say at 8:17?[1] Arsink Overism?<p>[1]: <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;live&#x2F;1UnoBfw6soI?si=R8nJ1FxdE4zBuO0i&amp;t=497">https:&#x2F;&#x2F;www.youtube.com&#x2F;live&#x2F;1UnoBfw6soI?si=R8nJ1FxdE4zBuO0i...</a></div><br/><div id="37815978" class="c"><input type="checkbox" id="c-37815978" checked=""/><div class="controls bullet"><span class="by">mastensg</span><span>|</span><a href="#37812577">root</a><span>|</span><a href="#37815564">parent</a><span>|</span><a href="#37815850">next</a><span>|</span><label class="collapse" for="c-37815978">[-]</label><label class="expand" for="c-37815978">[1 more]</label></div><br/><div class="children"><div class="content">&quot;rsync algorithm&quot;</div><br/></div></div></div></div></div></div><div id="37815850" class="c"><input type="checkbox" id="c-37815850" checked=""/><div class="controls bullet"><span class="by">eigenform</span><span>|</span><a href="#37812577">prev</a><span>|</span><a href="#37817879">next</a><span>|</span><label class="collapse" for="c-37815850">[-]</label><label class="expand" for="c-37815850">[1 more]</label></div><br/><div class="children"><div class="content">would&#x27;ve been nice to see a whole copy of the actual GCC binary in question :(<p>edit: looks like it dies in this: <a href="https:&#x2F;&#x2F;github.com&#x2F;gcc-mirror&#x2F;gcc&#x2F;blob&#x2F;master&#x2F;gcc&#x2F;tree-switch-conversion.cc#L1851">https:&#x2F;&#x2F;github.com&#x2F;gcc-mirror&#x2F;gcc&#x2F;blob&#x2F;master&#x2F;gcc&#x2F;tree-switc...</a><p>edit2: it also would&#x27;ve been nice to see the actual bytes being decoded when it faults, maybe it ends up spuriously writing over .text<p>edit3: on the LKML <a href="https:&#x2F;&#x2F;lore.kernel.org&#x2F;lkml&#x2F;D99589F4-BC5D-430B-87B2-72C20370CF57@exactcode.com&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;lore.kernel.org&#x2F;lkml&#x2F;D99589F4-BC5D-430B-87B2-72C2037...</a></div><br/></div></div><div id="37815644" class="c"><input type="checkbox" id="c-37815644" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#37817879">prev</a><span>|</span><a href="#37817707">next</a><span>|</span><label class="collapse" for="c-37815644">[-]</label><label class="expand" for="c-37815644">[1 more]</label></div><br/><div class="children"><div class="content">I am reminded of this article several years ago remarking on Intel&#x27;s CPU bugs: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=16058920">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=16058920</a><p>Perhaps AMD has also gone down the same path. It&#x27;s unfortunate that the hardware industry has also formalised planned obsolescence (&quot;end of life&quot; and similar phrasings) which drastically decreases the motivation to achieve perfection, as they can then defer &quot;fixing&quot; anything to &quot;buy the new model&quot; (complete with its own, unknown, new set of bugs...)</div><br/></div></div><div id="37817707" class="c"><input type="checkbox" id="c-37817707" checked=""/><div class="controls bullet"><span class="by">iforgotpassword</span><span>|</span><a href="#37815644">prev</a><span>|</span><a href="#37813712">next</a><span>|</span><label class="collapse" for="c-37817707">[-]</label><label class="expand" for="c-37817707">[1 more]</label></div><br/><div class="children"><div class="content">I think there was a post a few months ago that in recent AMD CPUs with up to date microcode, mitigations=off actually runs slower than leaving them on. This here seems to be the final nail in the coffin for turning them off, at least on AMD. In the very beginning we decided to turn them off on our fleet of Linux devices, but stopped after that post, even though we don&#x27;t even run any AMD currently.</div><br/></div></div><div id="37813712" class="c"><input type="checkbox" id="c-37813712" checked=""/><div class="controls bullet"><span class="by">nubinetwork</span><span>|</span><a href="#37817707">prev</a><span>|</span><a href="#37813853">next</a><span>|</span><label class="collapse" for="c-37813712">[-]</label><label class="expand" for="c-37813712">[4 more]</label></div><br/><div class="children"><div class="content">Still waiting for amd to fix random bugs in znver1.  <a href="https:&#x2F;&#x2F;bugs.gentoo.org&#x2F;724314" rel="nofollow noreferrer">https:&#x2F;&#x2F;bugs.gentoo.org&#x2F;724314</a></div><br/><div id="37813999" class="c"><input type="checkbox" id="c-37813999" checked=""/><div class="controls bullet"><span class="by">ta988</span><span>|</span><a href="#37813712">parent</a><span>|</span><a href="#37813853">next</a><span>|</span><label class="collapse" for="c-37813999">[-]</label><label class="expand" for="c-37813999">[3 more]</label></div><br/><div class="children"><div class="content">Unlikely to happen.</div><br/><div id="37815271" class="c"><input type="checkbox" id="c-37815271" checked=""/><div class="controls bullet"><span class="by">vlovich123</span><span>|</span><a href="#37813712">root</a><span>|</span><a href="#37813999">parent</a><span>|</span><a href="#37813853">next</a><span>|</span><label class="collapse" for="c-37815271">[-]</label><label class="expand" for="c-37815271">[2 more]</label></div><br/><div class="children"><div class="content">From the end of the bug tracker sounds like the issue is actually resolved (or at least no longer repros)</div><br/><div id="37816981" class="c"><input type="checkbox" id="c-37816981" checked=""/><div class="controls bullet"><span class="by">ta988</span><span>|</span><a href="#37813712">root</a><span>|</span><a href="#37815271">parent</a><span>|</span><a href="#37813853">next</a><span>|</span><label class="collapse" for="c-37816981">[-]</label><label class="expand" for="c-37816981">[1 more]</label></div><br/><div class="children"><div class="content">yes solved in the compilers not at the cpu level.</div><br/></div></div></div></div></div></div></div></div><div id="37813853" class="c"><input type="checkbox" id="c-37813853" checked=""/><div class="controls bullet"><span class="by">nightfly</span><span>|</span><a href="#37813712">prev</a><span>|</span><a href="#37813977">next</a><span>|</span><label class="collapse" for="c-37813853">[-]</label><label class="expand" for="c-37813853">[2 more]</label></div><br/><div class="children"><div class="content">Have they tested this on more than one machine? This seems like it could be a hardware fault</div><br/></div></div><div id="37813977" class="c"><input type="checkbox" id="c-37813977" checked=""/><div class="controls bullet"><span class="by">nathants</span><span>|</span><a href="#37813853">prev</a><span>|</span><a href="#37814259">next</a><span>|</span><label class="collapse" for="c-37813977">[-]</label><label class="expand" for="c-37813977">[3 more]</label></div><br/><div class="children"><div class="content">lucky me, i’m running mitigations=off and smt=off on a 7950x.</div><br/><div id="37814545" class="c"><input type="checkbox" id="c-37814545" checked=""/><div class="controls bullet"><span class="by">zamadatix</span><span>|</span><a href="#37813977">parent</a><span>|</span><a href="#37814259">next</a><span>|</span><label class="collapse" for="c-37814545">[-]</label><label class="expand" for="c-37814545">[2 more]</label></div><br/><div class="children"><div class="content">Out of curiosity did you have smt=off for performance reasons or other reasons?</div><br/><div id="37814616" class="c"><input type="checkbox" id="c-37814616" checked=""/><div class="controls bullet"><span class="by">nathants</span><span>|</span><a href="#37813977">root</a><span>|</span><a href="#37814545">parent</a><span>|</span><a href="#37814259">next</a><span>|</span><label class="collapse" for="c-37814616">[-]</label><label class="expand" for="c-37814616">[1 more]</label></div><br/><div class="children"><div class="content">performance testing vulkan and physx on linux.</div><br/></div></div></div></div></div></div><div id="37817920" class="c"><input type="checkbox" id="c-37817920" checked=""/><div class="controls bullet"><span class="by">formerly_proven</span><span>|</span><a href="#37814259">prev</a><span>|</span><a href="#37814569">next</a><span>|</span><label class="collapse" for="c-37817920">[-]</label><label class="expand" for="c-37817920">[1 more]</label></div><br/><div class="children"><div class="content">GCC crashing on Zen CPUs, I&#x27;ve heard that one before.</div><br/></div></div><div id="37813631" class="c"><input type="checkbox" id="c-37813631" checked=""/><div class="controls bullet"><span class="by">secondcoming</span><span>|</span><a href="#37814781">prev</a><span>|</span><label class="collapse" for="c-37813631">[-]</label><label class="expand" for="c-37813631">[4 more]</label></div><br/><div class="children"><div class="content">Isn&#x27;t there a rule about titles containing &#x27;considered harmful&#x27;?<p>Either way, this is pretty interesting and the guy is pretty excited about finding it.</div><br/><div id="37813738" class="c"><input type="checkbox" id="c-37813738" checked=""/><div class="controls bullet"><span class="by">fabianhjr</span><span>|</span><a href="#37813631">parent</a><span>|</span><a href="#37814496">next</a><span>|</span><label class="collapse" for="c-37813738">[-]</label><label class="expand" for="c-37813738">[2 more]</label></div><br/><div class="children"><div class="content">There is a rule on mostly not editorializing titles and in this case that is the title of the source article.<p>&gt; Otherwise please use the original title, unless it is misleading or linkbait; don&#x27;t editorialize.</div><br/></div></div><div id="37814496" class="c"><input type="checkbox" id="c-37814496" checked=""/><div class="controls bullet"><span class="by">burnished</span><span>|</span><a href="#37813631">parent</a><span>|</span><a href="#37813738">prev</a><span>|</span><label class="collapse" for="c-37814496">[-]</label><label class="expand" for="c-37814496">[1 more]</label></div><br/><div class="children"><div class="content">I think its merely considered gauche, that and people seem to have broadly realized anyone could use that phrase to imply consensus.</div><br/></div></div></div></div></div></div></div></div></div></body></html>