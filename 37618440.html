<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1695632463156" as="style"/><link rel="stylesheet" href="styles.css?v=1695632463156"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://lemire.me/blog/2023/09/22/parsing-integers-quickly-with-avx-512/">Parsing integers quickly with AVX-512</a> <span class="domain">(<a href="https://lemire.me">lemire.me</a>)</span></div><div class="subtext"><span>usdogu</span> | <span>24 comments</span></div><br/><div><div id="37641103" class="c"><input type="checkbox" id="c-37641103" checked=""/><div class="controls bullet"><span class="by">rwmj</span><span>|</span><a href="#37637756">next</a><span>|</span><label class="collapse" for="c-37641103">[-]</label><label class="expand" for="c-37641103">[1 more]</label></div><br/><div class="children"><div class="content">Does this handle the case where you try to parse a short string which is abutting the end of a page, and the next page is unmapped?  The problem is you over-read and crash when you try to read the unmapped page.  Looking at the code it doesn&#x27;t seem to take account of that case.</div><br/></div></div><div id="37637756" class="c"><input type="checkbox" id="c-37637756" checked=""/><div class="controls bullet"><span class="by">nly</span><span>|</span><a href="#37641103">prev</a><span>|</span><a href="#37638634">next</a><span>|</span><label class="collapse" for="c-37637756">[-]</label><label class="expand" for="c-37637756">[4 more]</label></div><br/><div class="children"><div class="content">17 cycles still seems pretty slow compared to the methods explored in this article, which got the result down to 0.75ns (~3 cycles?) (for integer strings of a known length):<p><a href="https:&#x2F;&#x2F;kholdstare.github.io&#x2F;technical&#x2F;2020&#x2F;05&#x2F;26&#x2F;faster-integer-parsing.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;kholdstare.github.io&#x2F;technical&#x2F;2020&#x2F;05&#x2F;26&#x2F;faster-int...</a><p>Most of the overhead is found in dealing with variable length input, minus signs, and overflow checking.</div><br/><div id="37637908" class="c"><input type="checkbox" id="c-37637908" checked=""/><div class="controls bullet"><span class="by">foota</span><span>|</span><a href="#37637756">parent</a><span>|</span><a href="#37639528">next</a><span>|</span><label class="collapse" for="c-37637908">[-]</label><label class="expand" for="c-37637908">[1 more]</label></div><br/><div class="children"><div class="content">I think the technique there is largely covered within the op, but it seems like this may be a somewhat well known technique.</div><br/></div></div><div id="37639528" class="c"><input type="checkbox" id="c-37639528" checked=""/><div class="controls bullet"><span class="by">kolbe</span><span>|</span><a href="#37637756">parent</a><span>|</span><a href="#37637908">prev</a><span>|</span><a href="#37638634">next</a><span>|</span><label class="collapse" for="c-37639528">[-]</label><label class="expand" for="c-37639528">[2 more]</label></div><br/><div class="children"><div class="content">I&#x27;m guessing the instruction pipeline gets packed, so 4-5x more than 3 cyles.</div><br/><div id="37640900" class="c"><input type="checkbox" id="c-37640900" checked=""/><div class="controls bullet"><span class="by">nly</span><span>|</span><a href="#37637756">root</a><span>|</span><a href="#37639528">parent</a><span>|</span><a href="#37638634">next</a><span>|</span><label class="collapse" for="c-37640900">[-]</label><label class="expand" for="c-37640900">[1 more]</label></div><br/><div class="children"><div class="content">If all you care about is throughput, that&#x27;s what you want</div><br/></div></div></div></div></div></div><div id="37638634" class="c"><input type="checkbox" id="c-37638634" checked=""/><div class="controls bullet"><span class="by">benreesman</span><span>|</span><a href="#37637756">prev</a><span>|</span><a href="#37640727">next</a><span>|</span><label class="collapse" for="c-37638634">[-]</label><label class="expand" for="c-37638634">[1 more]</label></div><br/><div class="children"><div class="content">This has been floating around in my random stuff directory for ages, while I think it&#x27;s technically somewhere in the repo of a former employer if that recollection is correct it was copied without attribution from some random website so, fair game. I&#x27;ve always found it useful for thinking about this family of algorithm:<p><a href="https:&#x2F;&#x2F;gist.github.com&#x2F;b7r6&#x2F;0f80c18035d4db0dba298decc0b1adac" rel="nofollow noreferrer">https:&#x2F;&#x2F;gist.github.com&#x2F;b7r6&#x2F;0f80c18035d4db0dba298decc0b1ada...</a></div><br/></div></div><div id="37640727" class="c"><input type="checkbox" id="c-37640727" checked=""/><div class="controls bullet"><span class="by">modeless</span><span>|</span><a href="#37638634">prev</a><span>|</span><a href="#37639501">next</a><span>|</span><label class="collapse" for="c-37640727">[-]</label><label class="expand" for="c-37640727">[2 more]</label></div><br/><div class="children"><div class="content">If you&#x27;re parsing lots of numbers and they are often of similar length, then could you go for GPU-style SIMT with AVX-512 and parse 64 numbers at once?</div><br/><div id="37641023" class="c"><input type="checkbox" id="c-37641023" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#37640727">parent</a><span>|</span><a href="#37639501">next</a><span>|</span><label class="collapse" for="c-37641023">[-]</label><label class="expand" for="c-37641023">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s not clear that this will be a win because the really-wide transpose at the beginning could be pretty expensive.</div><br/></div></div></div></div><div id="37639501" class="c"><input type="checkbox" id="c-37639501" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#37640727">prev</a><span>|</span><a href="#37638399">next</a><span>|</span><label class="collapse" for="c-37639501">[-]</label><label class="expand" for="c-37639501">[2 more]</label></div><br/><div class="children"><div class="content">Readers can try their hand at a similar problem using AVX2 here: <a href="https:&#x2F;&#x2F;highload.fun&#x2F;tasks&#x2F;1&#x2F;leaderboard" rel="nofollow noreferrer">https:&#x2F;&#x2F;highload.fun&#x2F;tasks&#x2F;1&#x2F;leaderboard</a></div><br/><div id="37641068" class="c"><input type="checkbox" id="c-37641068" checked=""/><div class="controls bullet"><span class="by">5-</span><span>|</span><a href="#37639501">parent</a><span>|</span><a href="#37638399">next</a><span>|</span><label class="collapse" for="c-37641068">[-]</label><label class="expand" for="c-37641068">[1 more]</label></div><br/><div class="children"><div class="content">incidentally: what&#x27;s the term for a foreign-language word creation in a different culture?<p>as far as i can tell, &quot;highload&quot; (typically spelt in english) exists only in the russian-speaking communities and means &quot;high performance&quot;.</div><br/></div></div></div></div><div id="37638399" class="c"><input type="checkbox" id="c-37638399" checked=""/><div class="controls bullet"><span class="by">ggm</span><span>|</span><a href="#37639501">prev</a><span>|</span><a href="#37638588">next</a><span>|</span><label class="collapse" for="c-37638399">[-]</label><label class="expand" for="c-37638399">[6 more]</label></div><br/><div class="children"><div class="content">Considered as a naieve problem, inescapably you want to perform a series of multiply and addition phases. For short strings, &quot;just do it&quot; might be slower than &quot;look it up in a table&quot;. For longer strings, divide-and-conquer would be to chop it into short strings and do the table lookup.<p>I don&#x27;t know this is faster than simply doing the &quot;mutiply by ten and add&quot; sequence. I&#x27;d have to understand modern ALU behaviour, parallelism, shortcuts, chip cache dynamics you-name-it.<p>It would all have been so much simpler if we&#x27;d made decimal be hex instead. Octal doesn&#x27;t work as well for me, no idea why. That said, it&#x27;s much easier to ignore thumbs and count on 4 fingers of each hand than grow another 6<p>(I read the article. It descended into arcanum of instruction sets and assumptions which post date my DEC-10 ISA lessons, although I recall Digital had BCD instruction handling and a 6 bit byte model in a 36 bit word accordingly. DEC-10 instructions could take many, many clock cycles and have 5 components of from, to, via, because, maybe attached to them)</div><br/><div id="37639000" class="c"><input type="checkbox" id="c-37639000" checked=""/><div class="controls bullet"><span class="by">mattgrice</span><span>|</span><a href="#37638399">parent</a><span>|</span><a href="#37638588">next</a><span>|</span><label class="collapse" for="c-37639000">[-]</label><label class="expand" for="c-37639000">[5 more]</label></div><br/><div class="children"><div class="content">Maybe in the future don&#x27;t comment on articles until you have read and understand them.<p>And while your comments on DEC-10 and 6-bit bytes might be interesting, there are  very few people still working in CS who have seen a DEC-10 outside a museum.  I find it always interesting to learn about computers that were obsolete before I wrote my first program, but their performance characteristics were vastly different than what we have today.  And current college grads have always lived in a world with 64-bit SIMD machines that can do a scalar multiply in 3-4 cycles.<p>[Edit to add]
I don&#x27;t know why I&#x27;m salty about this, but Doug Lemire is real good and doesn&#x27;t deserve to be blown off, especially not by someone referencing a computer that was obsolete before today&#x27;s retirement-age CS people were in high school.  VAX obsoleted the DEC-10 in 1977.</div><br/><div id="37639751" class="c"><input type="checkbox" id="c-37639751" checked=""/><div class="controls bullet"><span class="by">jzwinck</span><span>|</span><a href="#37638399">root</a><span>|</span><a href="#37639000">parent</a><span>|</span><a href="#37640705">next</a><span>|</span><label class="collapse" for="c-37639751">[-]</label><label class="expand" for="c-37639751">[2 more]</label></div><br/><div class="children"><div class="content">I agree but it&#x27;s Daniel not Doug.</div><br/><div id="37639883" class="c"><input type="checkbox" id="c-37639883" checked=""/><div class="controls bullet"><span class="by">mattgrice</span><span>|</span><a href="#37638399">root</a><span>|</span><a href="#37639751">parent</a><span>|</span><a href="#37640705">next</a><span>|</span><label class="collapse" for="c-37639883">[-]</label><label class="expand" for="c-37639883">[1 more]</label></div><br/><div class="children"><div class="content">you are correct, sir.  Sorry to Daniel.</div><br/></div></div></div></div><div id="37640705" class="c"><input type="checkbox" id="c-37640705" checked=""/><div class="controls bullet"><span class="by">benj111</span><span>|</span><a href="#37638399">root</a><span>|</span><a href="#37639000">parent</a><span>|</span><a href="#37639751">prev</a><span>|</span><a href="#37638588">next</a><span>|</span><label class="collapse" for="c-37640705">[-]</label><label class="expand" for="c-37640705">[2 more]</label></div><br/><div class="children"><div class="content">I agree with the parent, but from a different angle.<p>If you need to parse integers so quickly, why are you storing them as decimal strings?<p>If you&#x27;re dealing with a massive CSV why not just compile to a more easily parsable format ahead of time?</div><br/><div id="37641030" class="c"><input type="checkbox" id="c-37641030" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#37638399">root</a><span>|</span><a href="#37640705">parent</a><span>|</span><a href="#37638588">next</a><span>|</span><label class="collapse" for="c-37641030">[-]</label><label class="expand" for="c-37641030">[1 more]</label></div><br/><div class="children"><div class="content">Because we receive them over the wire as decimal strings.</div><br/></div></div></div></div></div></div></div></div><div id="37638588" class="c"><input type="checkbox" id="c-37638588" checked=""/><div class="controls bullet"><span class="by">ape4</span><span>|</span><a href="#37638399">prev</a><span>|</span><a href="#37638324">next</a><span>|</span><label class="collapse" for="c-37638588">[-]</label><label class="expand" for="c-37638588">[6 more]</label></div><br/><div class="children"><div class="content">Do library atoi() actually do SIMD?</div><br/><div id="37639747" class="c"><input type="checkbox" id="c-37639747" checked=""/><div class="controls bullet"><span class="by">jzwinck</span><span>|</span><a href="#37638588">parent</a><span>|</span><a href="#37638793">next</a><span>|</span><label class="collapse" for="c-37639747">[-]</label><label class="expand" for="c-37639747">[1 more]</label></div><br/><div class="children"><div class="content">Not literally atoi() because most people don&#x27;t use that anymore, but the C++ std::from_chars() uses SIMD in GCC 12+, thanks to some of the same people behind the OP:
 <a href="https:&#x2F;&#x2F;lemire.me&#x2F;blog&#x2F;2022&#x2F;07&#x2F;27&#x2F;comparing-strtod-with-from_chars-gcc-12&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;lemire.me&#x2F;blog&#x2F;2022&#x2F;07&#x2F;27&#x2F;comparing-strtod-with-from...</a></div><br/></div></div><div id="37638793" class="c"><input type="checkbox" id="c-37638793" checked=""/><div class="controls bullet"><span class="by">vinkelhake</span><span>|</span><a href="#37638588">parent</a><span>|</span><a href="#37639747">prev</a><span>|</span><a href="#37639638">next</a><span>|</span><label class="collapse" for="c-37638793">[-]</label><label class="expand" for="c-37638793">[3 more]</label></div><br/><div class="children"><div class="content">That would depend on the implementation. But it doesn&#x27;t really matter, no one should be using atoi.</div><br/><div id="37639665" class="c"><input type="checkbox" id="c-37639665" checked=""/><div class="controls bullet"><span class="by">stingraycharles</span><span>|</span><a href="#37638588">root</a><span>|</span><a href="#37638793">parent</a><span>|</span><a href="#37639638">next</a><span>|</span><label class="collapse" for="c-37639665">[-]</label><label class="expand" for="c-37639665">[2 more]</label></div><br/><div class="children"><div class="content">Yeah, iirc it was exploitable because it doesn’t do any bounds checking or something like that, right?</div><br/><div id="37640099" class="c"><input type="checkbox" id="c-37640099" checked=""/><div class="controls bullet"><span class="by">Lt_Riza_Hawkeye</span><span>|</span><a href="#37638588">root</a><span>|</span><a href="#37639665">parent</a><span>|</span><a href="#37639638">next</a><span>|</span><label class="collapse" for="c-37640099">[-]</label><label class="expand" for="c-37640099">[1 more]</label></div><br/><div class="children"><div class="content">It bounds checks just fine, as long as you pass it a null-terminated string. It just returns 0 on error, so there&#x27;s no way to know if the string was for example, larger than would fit in an int, or even just totally invalid, or if the user actually entered 0.</div><br/></div></div></div></div></div></div><div id="37639638" class="c"><input type="checkbox" id="c-37639638" checked=""/><div class="controls bullet"><span class="by">anonymoushn</span><span>|</span><a href="#37638588">parent</a><span>|</span><a href="#37638793">prev</a><span>|</span><a href="#37638324">next</a><span>|</span><label class="collapse" for="c-37639638">[-]</label><label class="expand" for="c-37639638">[1 more]</label></div><br/><div class="children"><div class="content">In general almost nothing uses SIMD for processing strings :(</div><br/></div></div></div></div></div></div></div></div></div></body></html>