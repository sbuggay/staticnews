<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1711616476172" as="style"/><link rel="stylesheet" href="styles.css?v=1711616476172"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://github.com/meribold/btry">Show HN: A (marginally) useful x86-64 ELF executable in 466 bytes</a> <span class="domain">(<a href="https://github.com">github.com</a>)</span></div><div class="subtext"><span>meribold</span> | <span>17 comments</span></div><br/><div><div id="39845228" class="c"><input type="checkbox" id="c-39845228" checked=""/><div class="controls bullet"><span class="by">meribold</span><span>|</span><a href="#39845300">next</a><span>|</span><label class="collapse" for="c-39845228">[-]</label><label class="expand" for="c-39845228">[4 more]</label></div><br/><div class="children"><div class="content">This project is a rewrite of a Bash script that I started to teach myself a little bit of x86 assembly. I still don&#x27;t know much, but I did learn that ELF executables can be surprisingly small and simple for a very basic program. A 64-byte file header and a single 56-byte program header are the only &quot;overhead&quot; that is really mandatory (and it&#x27;s even possible to make those overlap a little).<p>But it&#x27;s difficult to stop the linker from adding extra stuff, which is why I eventually specified the headers (and three addresses) by hand in the assembly file and stopped using a linker.</div><br/><div id="39846266" class="c"><input type="checkbox" id="c-39846266" checked=""/><div class="controls bullet"><span class="by">LegionMammal978</span><span>|</span><a href="#39845228">parent</a><span>|</span><a href="#39845762">next</a><span>|</span><label class="collapse" for="c-39846266">[-]</label><label class="expand" for="c-39846266">[1 more]</label></div><br/><div class="children"><div class="content">Good luck on your x86-golfing journey! If it helps, I have a nice template for overlapping the two headers into 80 bytes, and stuffing up to ~24 bytes of instructions into them. It&#x27;s included near the top of my article on the smallest x86-64 ELF Hello World [0]. (In the same article, I have a 73-byte template that&#x27;s a bit shorter but trickier to use.)<p>You may find some of the other tricks in the article helpful, but it might be hard to follow depending on your level of experience with assembly. My general advice would be that &#x27;push&#x27; and &#x27;pop&#x27; are your two best friends if you want to move around 64-bit values.<p>[0] <a href="https:&#x2F;&#x2F;tmpout.sh&#x2F;3&#x2F;22.html" rel="nofollow">https:&#x2F;&#x2F;tmpout.sh&#x2F;3&#x2F;22.html</a></div><br/></div></div><div id="39845762" class="c"><input type="checkbox" id="c-39845762" checked=""/><div class="controls bullet"><span class="by">samatman</span><span>|</span><a href="#39845228">parent</a><span>|</span><a href="#39846266">prev</a><span>|</span><a href="#39845300">next</a><span>|</span><label class="collapse" for="c-39845762">[-]</label><label class="expand" for="c-39845762">[2 more]</label></div><br/><div class="children"><div class="content">The installation instructions made me smile. &quot;turn this Base64 string into an executable&quot; is the new &quot;curl | sh&quot;!<p>Why did you decide to build the string backward?</div><br/><div id="39845962" class="c"><input type="checkbox" id="c-39845962" checked=""/><div class="controls bullet"><span class="by">meribold</span><span>|</span><a href="#39845228">root</a><span>|</span><a href="#39845762">parent</a><span>|</span><a href="#39845300">next</a><span>|</span><label class="collapse" for="c-39845962">[-]</label><label class="expand" for="c-39845962">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t remember if it&#x27;s why I initially did it, but it allows hardcoding the final characters of the output string (&quot;%)\n&quot;) somewhere into the ELF header where they don&#x27;t do damage ahead of execution.</div><br/></div></div></div></div></div></div><div id="39845300" class="c"><input type="checkbox" id="c-39845300" checked=""/><div class="controls bullet"><span class="by">fear91</span><span>|</span><a href="#39845228">prev</a><span>|</span><a href="#39848448">next</a><span>|</span><label class="collapse" for="c-39845300">[-]</label><label class="expand" for="c-39845300">[3 more]</label></div><br/><div class="children"><div class="content">You can shrink it further by doing xorl reg, reg. On x86, the upper 32 bits are cleared for you when using 32 bit opcodes. No need to do a 64-bit reg, reg xor.<p>Instead of doing cmp $0, %eax, you can use test eax, eax - that&#x27;s another low hanging fruit.<p>It seems that you could also preset a dedicated reg to 0 and another to 1, further shaving a few bytes.</div><br/><div id="39845444" class="c"><input type="checkbox" id="c-39845444" checked=""/><div class="controls bullet"><span class="by">meribold</span><span>|</span><a href="#39845300">parent</a><span>|</span><a href="#39846249">next</a><span>|</span><label class="collapse" for="c-39845444">[-]</label><label class="expand" for="c-39845444">[1 more]</label></div><br/><div class="children"><div class="content">Thanks for the suggestions! I&#x27;ll definitely look into those. I&#x27;d been hoping posting on HN would result in being able to shave off yet a few more bytes.</div><br/></div></div><div id="39846249" class="c"><input type="checkbox" id="c-39846249" checked=""/><div class="controls bullet"><span class="by">userbinator</span><span>|</span><a href="#39845300">parent</a><span>|</span><a href="#39845444">prev</a><span>|</span><a href="#39848448">next</a><span>|</span><label class="collapse" for="c-39846249">[-]</label><label class="expand" for="c-39846249">[1 more]</label></div><br/><div class="children"><div class="content">Also learn the string instructions --- I can see plenty of places where a lodsb would help greatly.</div><br/></div></div></div></div><div id="39848448" class="c"><input type="checkbox" id="c-39848448" checked=""/><div class="controls bullet"><span class="by">kitd</span><span>|</span><a href="#39845300">prev</a><span>|</span><a href="#39845197">next</a><span>|</span><label class="collapse" for="c-39848448">[-]</label><label class="expand" for="c-39848448">[2 more]</label></div><br/><div class="children"><div class="content">Love the installation instructions. No downloads, the instruction <i>is</i> the binary.</div><br/><div id="39848548" class="c"><input type="checkbox" id="c-39848548" checked=""/><div class="controls bullet"><span class="by">lifthrasiir</span><span>|</span><a href="#39848448">parent</a><span>|</span><a href="#39845197">next</a><span>|</span><label class="collapse" for="c-39848548">[-]</label><label class="expand" for="c-39848548">[1 more]</label></div><br/><div class="children"><div class="content">It is rather an xz-compressed binary. :-) The following would be an uncompressed version, and I personally don&#x27;t see any reason to use xz [1]. (Caution: Do not trust me on the validity of this instruction!)<p><pre><code>  base64 -d &lt;&lt;EOF &gt; btry &amp;&amp; chmod a+x btry
  f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAACQFAAAAAAAA4AAAAAAAAAAAAAAAAJSkKAAAAAEAAOAAB
  AAAABwAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAANIBAAAAAAAA0wEAAAAAAAAAEAAAAAAAAEgx
  wLACSDH2DwVIhcB4M0iJx0gxwEiNdCT3SDHSsgkPBf7ITTH2SDHJSDHSTWv2CopUDPeA6jBJAdZI
  &#x2F;8FIOch16sMx0kG5QEIPAEH38UGJwInQMdJBuaCGAQBB9&#x2F;FBsQpB9vGAxDBJ&#x2F;8qI4EGIAkn&#x2F;ykHG
  Ai5EicDoAQAAAMNBuQoAAAAx0kH38YDCMEn&#x2F;ykGIEoP4AHXtw0nHwi0AQABBvCBXaCBIx8eqAUAA
  6E7&#x2F;&#x2F;&#x2F;9Ix8eqAUAASIXAeGdFiffHRyRub3cA6DP&#x2F;&#x2F;&#x2F;9IMdJMifBIa8BkSff36KD&#x2F;&#x2F;&#x2F;9BxkL&#x2F;KEmD
  6gVFiSJEifjoUP&#x2F;&#x2F;&#x2F;2ZBx0L+LyBJg+oGRYkiRInw6Dr&#x2F;&#x2F;&#x2F;8xwP&#x2F;AicdMidZIx8IwAEAATCnSDwWw
  PEAw&#x2F;w8FZkG8IEHHRx1jaGFyxkciZelz&#x2F;&#x2F;&#x2F;&#x2F;L3N5cy9jbGFzcy9wb3dlcl9zdXBwbHkvQkFUMC9l
  bmVyZ3lfZnVsbA==
  EOF
</code></pre>
[1] Well, maybe that makes a sort-of free checksum though.</div><br/></div></div></div></div><div id="39845197" class="c"><input type="checkbox" id="c-39845197" checked=""/><div class="controls bullet"><span class="by">Kluggy</span><span>|</span><a href="#39848448">prev</a><span>|</span><a href="#39846469">next</a><span>|</span><label class="collapse" for="c-39845197">[-]</label><label class="expand" for="c-39845197">[2 more]</label></div><br/><div class="children"><div class="content">So this just reads &#x2F;sys&#x2F;class&#x2F;power_supply&#x2F;BAT0&#x2F;energy_now (or charge_now) and &#x2F;sys&#x2F;class&#x2F;power_supply&#x2F;BAT0&#x2F;charge_full and outputs it nicely. While the asm is cool, how large would the bash script to do it?</div><br/><div id="39845275" class="c"><input type="checkbox" id="c-39845275" checked=""/><div class="controls bullet"><span class="by">meribold</span><span>|</span><a href="#39845197">parent</a><span>|</span><a href="#39846469">next</a><span>|</span><label class="collapse" for="c-39845275">[-]</label><label class="expand" for="c-39845275">[1 more]</label></div><br/><div class="children"><div class="content">This project started as a rewrite of a Bash script (for learning purposes), so I can easily answer this question. It&#x27;s indeed small. Here&#x27;s the full Bash script I used to use (including comments):<p><pre><code>    #!&#x2F;usr&#x2F;bin&#x2F;env bash

    # Print the remaining amount of energy (or charge)
    # stored in the battery identified by `BAT0`.  This
    # is what works on my ThinkPad X220 and may not be
    # portable to other laptops without changes.

    cd &#x2F;sys&#x2F;class&#x2F;power_supply&#x2F;BAT0 || exit $?

    # Sometimes there are `energy_now` and `energy_full`
    # pseudofiles, and sometimes there are `charge_now`
    # and `charge_full` pseudofiles instead.
    if [[ -e energy_now ]]; then
       now=$(&lt;energy_now)
       full=$(&lt;energy_full)
       unit=Wh
    elif [[ -e charge_now ]]; then
       now=$(&lt;charge_now)
       full=$(&lt;charge_full)
       unit=Ah
    fi
    percent=$((100 * now &#x2F; full))
    # Convert from microwatt-hours (or microampere-hours)
    # to watt-hours (or ampere-hours).
    now=$(bc &lt;&lt;&lt; &quot;scale=1; $now &#x2F; 1000000&quot;)
    full=$(bc &lt;&lt;&lt; &quot;scale=1; $full &#x2F; 1000000&quot;)
    echo &quot;$now $unit &#x2F; $full $unit (${percent}%)&quot;</code></pre></div><br/></div></div></div></div><div id="39846469" class="c"><input type="checkbox" id="c-39846469" checked=""/><div class="controls bullet"><span class="by">im3w1l</span><span>|</span><a href="#39845197">prev</a><span>|</span><a href="#39844686">next</a><span>|</span><label class="collapse" for="c-39846469">[-]</label><label class="expand" for="c-39846469">[2 more]</label></div><br/><div class="children"><div class="content">This is kind of a tangent, but there are two types of programming that seem like fun little games. On the one hand low-level assembly and on the other hand high-level code that uses logic or type system trickery to prove various correctness or at least some nice properties of the program.<p>I just hope that someone at some point figures out how to combine these two things, so we can pursue the best possible way of writing a program, and then prove it correct too. This would be a sort-of immortal program that would never need updating. Well, until it becomes obsolete because the world has changed around it.</div><br/><div id="39847686" class="c"><input type="checkbox" id="c-39847686" checked=""/><div class="controls bullet"><span class="by">binary132</span><span>|</span><a href="#39846469">parent</a><span>|</span><a href="#39844686">next</a><span>|</span><label class="collapse" for="c-39847686">[-]</label><label class="expand" for="c-39847686">[1 more]</label></div><br/><div class="children"><div class="content">I am slowly working on a “programmable assembler” for basically this purpose — the hope is to start with making it easier to construct simple binaries while also leaving headroom to build abstractions for proofs as scripts.</div><br/></div></div></div></div></div></div></div></div></div></body></html>