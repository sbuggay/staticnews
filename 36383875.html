<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1687165250065" as="style"/><link rel="stylesheet" href="styles.css?v=1687165250065"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://redbean.systems/">Redbean Systems</a> <span class="domain">(<a href="https://redbean.systems">redbean.systems</a>)</span></div><div class="subtext"><span>todsacerdoti</span> | <span>29 comments</span></div><br/><div><div id="36388835" class="c"><input type="checkbox" id="c-36388835" checked=""/><div class="controls bullet"><span class="by">polyrand</span><span>|</span><a href="#36384426">next</a><span>|</span><label class="collapse" for="c-36388835">[-]</label><label class="expand" for="c-36388835">[1 more]</label></div><br/><div class="children"><div class="content">Really excited to see where this goes. Some time ago, @jart answered a message about using pledge() as WASM alternative [0], which made me believe this could be an alternative to using WASM when you just need a sandbox. I would love to be able to run arbitrary code without having to deal with containers, microVMs or having to use a language that supports WASM [2]<p>[0]: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=34647121">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=34647121</a><p>[2]: Even for the languages that support WASM, you usually have to deal with incompatible dependencies, properly configuring your compiler, etc.</div><br/></div></div><div id="36384426" class="c"><input type="checkbox" id="c-36384426" checked=""/><div class="controls bullet"><span class="by">modeless</span><span>|</span><a href="#36388835">prev</a><span>|</span><a href="#36385574">next</a><span>|</span><label class="collapse" for="c-36384426">[-]</label><label class="expand" for="c-36384426">[3 more]</label></div><br/><div class="children"><div class="content">Context: &quot;I&#x27;m building a new sandboxing technology. Who here wants to hack into it?&quot; From Justine Tunny (jart) <a href="https:&#x2F;&#x2F;twitter.com&#x2F;JustineTunney&#x2F;status&#x2F;1670465543470710785?s=20" rel="nofollow noreferrer">https:&#x2F;&#x2F;twitter.com&#x2F;JustineTunney&#x2F;status&#x2F;1670465543470710785...</a><p>&quot;It&#x27;s a SECCOMP + Landlock LSM implementation of OpenBSD pledge() and unveil(). Fully unprivileged sandboxing. No root or containers required.&quot;</div><br/><div id="36386159" class="c"><input type="checkbox" id="c-36386159" checked=""/><div class="controls bullet"><span class="by">hn_throwaway_99</span><span>|</span><a href="#36384426">parent</a><span>|</span><a href="#36385574">next</a><span>|</span><label class="collapse" for="c-36386159">[-]</label><label class="expand" for="c-36386159">[2 more]</label></div><br/><div class="children"><div class="content">A little more info for those not familiar with these terms (I was not):<p>1. pledge is a system call that a process can make that limits what subsequent system calls that process can execute, e.g. &quot;I pledge to only call X, Y, Z&quot;: <a href="https:&#x2F;&#x2F;unix.stackexchange.com&#x2F;questions&#x2F;410056&#x2F;what-is-openbsds-pledge-in-short" rel="nofollow noreferrer">https:&#x2F;&#x2F;unix.stackexchange.com&#x2F;questions&#x2F;410056&#x2F;what-is-open...</a><p>2. unveil is the analogous call to restrict filesystem paths: it limits which paths open is allowed to access: <a href="https:&#x2F;&#x2F;why-openbsd.rocks&#x2F;fact&#x2F;unveil&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;why-openbsd.rocks&#x2F;fact&#x2F;unveil&#x2F;</a></div><br/><div id="36386226" class="c"><input type="checkbox" id="c-36386226" checked=""/><div class="controls bullet"><span class="by">paulclinger</span><span>|</span><a href="#36384426">root</a><span>|</span><a href="#36386159">parent</a><span>|</span><a href="#36385574">next</a><span>|</span><label class="collapse" for="c-36386226">[-]</label><label class="expand" for="c-36386226">[1 more]</label></div><br/><div class="children"><div class="content">@jart also made a writeup on porting pledge to Linux specifically in the cosmopolitan context: <a href="https:&#x2F;&#x2F;justine.lol&#x2F;pledge&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;justine.lol&#x2F;pledge&#x2F;</a>.</div><br/></div></div></div></div></div></div><div id="36385574" class="c"><input type="checkbox" id="c-36385574" checked=""/><div class="controls bullet"><span class="by">chc4</span><span>|</span><a href="#36384426">prev</a><span>|</span><a href="#36385722">next</a><span>|</span><label class="collapse" for="c-36385574">[-]</label><label class="expand" for="c-36385574">[7 more]</label></div><br/><div class="children"><div class="content">The &quot;anet&quot; pledge says that &quot;this allows to accept, but not initiate socket connections&quot;...but then still appears to allow for creating new AF_INET SOCK_DGRAM sockets and sendto, which allows for sending UDP packets without an established connection. That&#x27;s probably a sandbox escape on a lot of systems, since you could sendto localhost UDP daemons.<p>In general the pledge syscall filters are very permissive, which makes it hard to be sure of security; Chromium libsandbox is insanely restrictive in contrast, because that&#x27;s really what&#x27;s needed to be confident in your attack surface, especially if you start worrying about kernel privilege escalation exploits like Chrome does. I wasn&#x27;t aware of the landlock LSM before this, though, which seems pretty neat and a lot less intrusive than selinux for application specific white&#x2F;blacklisting.</div><br/><div id="36385747" class="c"><input type="checkbox" id="c-36385747" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36385574">parent</a><span>|</span><a href="#36385722">next</a><span>|</span><label class="collapse" for="c-36385747">[-]</label><label class="expand" for="c-36385747">[6 more]</label></div><br/><div class="children"><div class="content">It needs to be able to send unix datagrams so it can blackhole your IP address in the RAW PREROUTING iptable if you DDOS the system. <a href="https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cadbee93520f17e1661845f50&#x2F;net&#x2F;turfwar&#x2F;blackholed.c#L64">https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cad...</a> You can&#x27;t ban someone&#x27;s IP without root. So we have two choices: (1) create a setuid binary the web server can launch that does it, or (2) run a daemon as root that listens for AF_UNIX datagrams. To do (1) I&#x27;d need to grant fork() + execve() privileges, which I view as more problematic than (2) which only needs sendto (possibly even just write). You&#x27;ve helped me realize that I can make the blackholed integration much tighter than the way it&#x27;s currently being implemented in <a href="https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cadbee93520f17e1661845f50&#x2F;third_party&#x2F;python&#x2F;Modules&#x2F;tokenbucket.c#L230">https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cad...</a> so thank you!<p>As for surface area, I expected people to rake me over the coals for blocking io_uring. I didn&#x27;t anticipate support for Google&#x27;s zeal. OpenBSD is actually <i>even more</i> permissive than me when it comes to letting stuff through pledge(&quot;stdio&quot;). <a href="https:&#x2F;&#x2F;github.com&#x2F;openbsd&#x2F;src&#x2F;blob&#x2F;fb5793d3d4d0fd4795586dd9601a4aa58f1f3efa&#x2F;sys&#x2F;kern&#x2F;kern_pledge.c#L117">https:&#x2F;&#x2F;github.com&#x2F;openbsd&#x2F;src&#x2F;blob&#x2F;fb5793d3d4d0fd4795586dd9...</a> Also surface area isn&#x27;t a weakness, it&#x27;s a paradigm. If a weakness actually exists, then you must exploit it. So long as you tell us what you did, for the post-mortem.</div><br/><div id="36385853" class="c"><input type="checkbox" id="c-36385853" checked=""/><div class="controls bullet"><span class="by">chc4</span><span>|</span><a href="#36385574">root</a><span>|</span><a href="#36385747">parent</a><span>|</span><a href="#36387439">next</a><span>|</span><label class="collapse" for="c-36385853">[-]</label><label class="expand" for="c-36385853">[4 more]</label></div><br/><div class="children"><div class="content">I was specifically talking about AF_INET dgram sockets, not AF_UNIX; I saw that it wasn&#x27;t pledged and assumed that was by design (since having that and sendto would be extremely unsafe, since you could connect to abstract unix sockets). If you want to use an inherited unix socket for the blacklisting, you should use SOCK_STREAM unix sockets instead so you can&#x27;t sendto. Even allowing localhost UDP sockets isn&#x27;t safe to expose to a sandbox, IMO, since Linux programs fairly often expose privileged operations over those and have no way of knowing the client is supposed to be sandboxed and rejected.</div><br/><div id="36385943" class="c"><input type="checkbox" id="c-36385943" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36385574">root</a><span>|</span><a href="#36385853">parent</a><span>|</span><a href="#36387439">next</a><span>|</span><label class="collapse" for="c-36385943">[-]</label><label class="expand" for="c-36385943">[3 more]</label></div><br/><div class="children"><div class="content">I see what you mean now. When we created the &quot;anet&quot; category, the main intent was to prevent redbean from making outbound HTTP connections. Allowing UDP looks like a copy and paste error. You&#x27;re correct that it is a weakness. Thank you for identifying it! I&#x27;m in the process of fixing it now. How would you like to be credited?</div><br/><div id="36386080" class="c"><input type="checkbox" id="c-36386080" checked=""/><div class="controls bullet"><span class="by">chc4</span><span>|</span><a href="#36385574">root</a><span>|</span><a href="#36385943">parent</a><span>|</span><a href="#36387439">next</a><span>|</span><label class="collapse" for="c-36386080">[-]</label><label class="expand" for="c-36386080">[2 more]</label></div><br/><div class="children"><div class="content">Just chc4 is fine, otherwise @sickeningsprawl@infosec.exchange (and Twitter, though I haven&#x27;t used that in several months).</div><br/><div id="36386177" class="c"><input type="checkbox" id="c-36386177" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36385574">root</a><span>|</span><a href="#36386080">parent</a><span>|</span><a href="#36387439">next</a><span>|</span><label class="collapse" for="c-36386177">[-]</label><label class="expand" for="c-36386177">[1 more]</label></div><br/><div class="children"><div class="content">See <a href="https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;commit&#x2F;48b2afb192ec18eca40c0b25603c02a2e3b578e9">https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;commit&#x2F;48b2afb192ec18ec...</a> and <a href="https:&#x2F;&#x2F;twitter.com&#x2F;JustineTunney&#x2F;status&#x2F;1670600564164657154" rel="nofollow noreferrer">https:&#x2F;&#x2F;twitter.com&#x2F;JustineTunney&#x2F;status&#x2F;1670600564164657154</a></div><br/></div></div></div></div></div></div></div></div><div id="36387439" class="c"><input type="checkbox" id="c-36387439" checked=""/><div class="controls bullet"><span class="by">JoachimSchipper</span><span>|</span><a href="#36385574">root</a><span>|</span><a href="#36385747">parent</a><span>|</span><a href="#36385853">prev</a><span>|</span><a href="#36385722">next</a><span>|</span><label class="collapse" for="c-36387439">[-]</label><label class="expand" for="c-36387439">[1 more]</label></div><br/><div class="children"><div class="content">I may just be confused, but couldn&#x27;t you pass a pipe into the whole (server) process, instead of having it open its own sockets? (In <a href="https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;48b2afb192ec18eca40c0b25603c02a2e3b578e9&#x2F;third_party&#x2F;python&#x2F;Modules&#x2F;tokenbucket.c#L247">https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;48b2afb192ec18eca4...</a>, I gather?)<p>I haven&#x27;t followed cosmopolitan &#x2F; Linux pledge() <i>too</i> closely; but I notice your SERVER_PLEDGE and CLIENT_PLEDGE include stdio, so I expect you have write(2) (and could thus handle a pipe, and maybe even a passed-in AF_UNIX socket?)<p>Or is making the challenge more interesting - by actually including some networking - part of the fun?</div><br/></div></div></div></div></div></div><div id="36385722" class="c"><input type="checkbox" id="c-36385722" checked=""/><div class="controls bullet"><span class="by">downut</span><span>|</span><a href="#36385574">prev</a><span>|</span><a href="#36384616">next</a><span>|</span><label class="collapse" for="c-36385722">[-]</label><label class="expand" for="c-36385722">[1 more]</label></div><br/><div class="children"><div class="content">Jeebus every time I get attention grabbed into diving into redbean I end up just getting on my knees and putting my forehead to the floor.<p>I would say game knows game but here barely game groks stratospheric game.  I am again in awe.</div><br/></div></div><div id="36384616" class="c"><input type="checkbox" id="c-36384616" checked=""/><div class="controls bullet"><span class="by">maxmcd</span><span>|</span><a href="#36385722">prev</a><span>|</span><a href="#36384582">next</a><span>|</span><label class="collapse" for="c-36384616">[-]</label><label class="expand" for="c-36384616">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;d love to understand more about what the &quot;.verynice()&quot; call does. Source is here: <a href="https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cadbee93520f17e1661845f50&#x2F;libc&#x2F;calls&#x2F;verynice.c#L26-L40">https:&#x2F;&#x2F;github.com&#x2F;jart&#x2F;cosmopolitan&#x2F;blob&#x2F;f10845ab9f847e4cad...</a><p>What are the effects of limiting a process priority?</div><br/><div id="36385551" class="c"><input type="checkbox" id="c-36385551" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36384616">parent</a><span>|</span><a href="#36384709">next</a><span>|</span><label class="collapse" for="c-36385551">[-]</label><label class="expand" for="c-36385551">[1 more]</label></div><br/><div class="children"><div class="content">The `nice` command alone (a.k.a. setpriority) doesn&#x27;t do much. The verynice() function is similar to saying:<p><pre><code>    #!&#x2F;bin&#x2F;sh
    exec ionice -c3 nice &quot;$@&quot;
</code></pre>
Since it uses SCHED_IDLE i&#x2F;o priority too. It&#x27;s intended to ensure that no matter how much you bog down the system with i&#x2F;o and cpu usage, my Emacs session and login shells will remain interactive and in control.</div><br/></div></div><div id="36384709" class="c"><input type="checkbox" id="c-36384709" checked=""/><div class="controls bullet"><span class="by">anamexis</span><span>|</span><a href="#36384616">parent</a><span>|</span><a href="#36385551">prev</a><span>|</span><a href="#36384582">next</a><span>|</span><label class="collapse" for="c-36384709">[-]</label><label class="expand" for="c-36384709">[1 more]</label></div><br/><div class="children"><div class="content">The wikipedia article for nice is a decent summary: <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Nice_(Unix)" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Nice_(Unix)</a></div><br/></div></div></div></div><div id="36384582" class="c"><input type="checkbox" id="c-36384582" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#36384616">prev</a><span>|</span><a href="#36384792">next</a><span>|</span><label class="collapse" for="c-36384582">[-]</label><label class="expand" for="c-36384582">[5 more]</label></div><br/><div class="children"><div class="content">I will be very surprised if SECCOMP and Landlock is enough to secure Linux. Will be interesting to see the result of this anyway!</div><br/><div id="36384838" class="c"><input type="checkbox" id="c-36384838" checked=""/><div class="controls bullet"><span class="by">rashkov</span><span>|</span><a href="#36384582">parent</a><span>|</span><a href="#36384792">next</a><span>|</span><label class="collapse" for="c-36384838">[-]</label><label class="expand" for="c-36384838">[4 more]</label></div><br/><div class="children"><div class="content">How come?</div><br/><div id="36388054" class="c"><input type="checkbox" id="c-36388054" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#36384582">root</a><span>|</span><a href="#36384838">parent</a><span>|</span><a href="#36387115">prev</a><span>|</span><a href="#36384792">next</a><span>|</span><label class="collapse" for="c-36388054">[-]</label><label class="expand" for="c-36388054">[2 more]</label></div><br/><div class="children"><div class="content">They&#x27;re based on blacklisting rather than whitelisting. Security based on blacklisting means you&#x27;re always going to forget to ban some critical thing. It&#x27;s why trying to allow HTML but filter out `&lt;script&gt;` tags never works.<p>An example of whitelisting would be a capability based OS like Fuchsia or a custom non-HTML markup like Markdown that you then allow to use specific safe features like formatting (yeah I know about HTML in Markdown).<p>That said, this approach is probably the best you can do in Linux by a long way. I can definitely see use cases - e.g. all those services that have to use ffmpeg to transcode videos should definitely use something like this.</div><br/><div id="36388298" class="c"><input type="checkbox" id="c-36388298" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36384582">root</a><span>|</span><a href="#36388054">parent</a><span>|</span><a href="#36384792">next</a><span>|</span><label class="collapse" for="c-36388298">[-]</label><label class="expand" for="c-36388298">[1 more]</label></div><br/><div class="children"><div class="content">Are you saying this about SECCOMP and Landlock? Just to be clear:<p>- unveil(), based on the Landlock LSM, is a function which whitelists files.<p>- pledge(), based on SECCOMP BPF, is a function which whitelists system calls.</div><br/></div></div></div></div></div></div></div></div><div id="36384792" class="c"><input type="checkbox" id="c-36384792" checked=""/><div class="controls bullet"><span class="by">2h</span><span>|</span><a href="#36384582">prev</a><span>|</span><a href="#36384786">next</a><span>|</span><label class="collapse" for="c-36384792">[-]</label><label class="expand" for="c-36384792">[2 more]</label></div><br/><div class="children"><div class="content">doesn&#x27;t work:<p>502 Bad Gateway</div><br/><div id="36387237" class="c"><input type="checkbox" id="c-36387237" checked=""/><div class="controls bullet"><span class="by">dgl</span><span>|</span><a href="#36384792">parent</a><span>|</span><a href="#36384786">next</a><span>|</span><label class="collapse" for="c-36387237">[-]</label><label class="expand" for="c-36387237">[1 more]</label></div><br/><div class="children"><div class="content">It appears it blocks you if you send an X-Forwarded-For header, but if you happen to be behind a proxy which sends one, you&#x27;ll find you can&#x27;t access it... Rather broken HTTP behaviour.</div><br/></div></div></div></div><div id="36384786" class="c"><input type="checkbox" id="c-36384786" checked=""/><div class="controls bullet"><span class="by">opportune</span><span>|</span><a href="#36384792">prev</a><span>|</span><label class="collapse" for="c-36384786">[-]</label><label class="expand" for="c-36384786">[6 more]</label></div><br/><div class="children"><div class="content">Do I get anything for breaking out of the sandbox or am I just testing someone’s side project for free?<p>edit: I tried anyway but the &quot;API&quot; just 502s, and the only thing I&#x27;ve been able to get it to return is the HTML with the source you see from the browser (but then later, just 502s), so I&#x27;m not sure if somebody already beat me&#x2F;borked it or if there is a bug or what.<p>If I had to guess what happened, someone borked the HTTP server handler processes in a way that&#x27;s unrecoverable</div><br/><div id="36385485" class="c"><input type="checkbox" id="c-36385485" checked=""/><div class="controls bullet"><span class="by">jart</span><span>|</span><a href="#36384786">parent</a><span>|</span><a href="#36385158">next</a><span>|</span><label class="collapse" for="c-36385485">[-]</label><label class="expand" for="c-36385485">[1 more]</label></div><br/><div class="children"><div class="content">Author here. I can offer you public recognition.<p>You&#x27;ll also enjoy the glory of being able to say you successfully hacked one of jart&#x27;s services.</div><br/></div></div><div id="36385158" class="c"><input type="checkbox" id="c-36385158" checked=""/><div class="controls bullet"><span class="by">lovasoa</span><span>|</span><a href="#36384786">parent</a><span>|</span><a href="#36385485">prev</a><span>|</span><a href="#36384812">next</a><span>|</span><label class="collapse" for="c-36385158">[-]</label><label class="expand" for="c-36385158">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s back online; it was just a log file that grew too large.</div><br/><div id="36386895" class="c"><input type="checkbox" id="c-36386895" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#36384786">root</a><span>|</span><a href="#36385158">parent</a><span>|</span><a href="#36384812">next</a><span>|</span><label class="collapse" for="c-36386895">[-]</label><label class="expand" for="c-36386895">[1 more]</label></div><br/><div class="children"><div class="content">...I guess that&#x27;s a kind of DoS? Almost but I guess not completely joking.</div><br/></div></div></div></div><div id="36384812" class="c"><input type="checkbox" id="c-36384812" checked=""/><div class="controls bullet"><span class="by">klysm</span><span>|</span><a href="#36384786">parent</a><span>|</span><a href="#36385158">prev</a><span>|</span><a href="#36384833">next</a><span>|</span><label class="collapse" for="c-36384812">[-]</label><label class="expand" for="c-36384812">[1 more]</label></div><br/><div class="children"><div class="content">It needs a bitcoin wallet or something hiding outside the sandbox</div><br/></div></div><div id="36384833" class="c"><input type="checkbox" id="c-36384833" checked=""/><div class="controls bullet"><span class="by">rashkov</span><span>|</span><a href="#36384786">parent</a><span>|</span><a href="#36384812">prev</a><span>|</span><label class="collapse" for="c-36384833">[-]</label><label class="expand" for="c-36384833">[1 more]</label></div><br/><div class="children"><div class="content">For the joy of hacking</div><br/></div></div></div></div></div></div></div></div></div></body></html>