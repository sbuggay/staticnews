<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1692781262601" as="style"/><link rel="stylesheet" href="styles.css?v=1692781262601"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://antonz.org/writing-package-manager/">Writing a Package Manager</a> <span class="domain">(<a href="https://antonz.org">antonz.org</a>)</span></div><div class="subtext"><span>celiktom</span> | <span>35 comments</span></div><br/><div><div id="37232360" class="c"><input type="checkbox" id="c-37232360" checked=""/><div class="controls bullet"><span class="by">david2ndaccount</span><span>|</span><a href="#37232496">next</a><span>|</span><label class="collapse" for="c-37232360">[-]</label><label class="expand" for="c-37232360">[3 more]</label></div><br/><div class="children"><div class="content">Honestly pretty strange to write a package manager for sqlite and to use directories + json files to store the data instead of sqlite.</div><br/><div id="37233332" class="c"><input type="checkbox" id="c-37233332" checked=""/><div class="controls bullet"><span class="by">gjvc</span><span>|</span><a href="#37232360">parent</a><span>|</span><a href="#37232671">next</a><span>|</span><label class="collapse" for="c-37233332">[-]</label><label class="expand" for="c-37233332">[1 more]</label></div><br/><div class="children"><div class="content">local system log &quot;files&quot; and package databases would be an excellent example of using sqlite</div><br/></div></div><div id="37232671" class="c"><input type="checkbox" id="c-37232671" checked=""/><div class="controls bullet"><span class="by">gosenx</span><span>|</span><a href="#37232360">parent</a><span>|</span><a href="#37233332">prev</a><span>|</span><a href="#37232496">next</a><span>|</span><label class="collapse" for="c-37232671">[-]</label><label class="expand" for="c-37232671">[1 more]</label></div><br/><div class="children"><div class="content">Great point</div><br/></div></div></div></div><div id="37232496" class="c"><input type="checkbox" id="c-37232496" checked=""/><div class="controls bullet"><span class="by">brabel</span><span>|</span><a href="#37232360">prev</a><span>|</span><a href="#37233306">next</a><span>|</span><label class="collapse" for="c-37232496">[-]</label><label class="expand" for="c-37232496">[3 more]</label></div><br/><div class="children"><div class="content">The author added a lockfile without understanding why they exist.<p>A lockfile is meant to &quot;freeze&quot; dependency version resolution when package authors can specify dependencies on other packages using version ranges... it also &quot;freezes&quot; choices of transitive packages&#x27; versions when different packages depend on the same one, but with different versions.<p>They chose to not handle package dependencies at all, and I believe there&#x27;s no version ranges either, so I really don&#x27;t see why they added a lockfile.</div><br/><div id="37232579" class="c"><input type="checkbox" id="c-37232579" checked=""/><div class="controls bullet"><span class="by">pharmakom</span><span>|</span><a href="#37232496">parent</a><span>|</span><a href="#37232895">next</a><span>|</span><label class="collapse" for="c-37232579">[-]</label><label class="expand" for="c-37232579">[1 more]</label></div><br/><div class="children"><div class="content">A version number is just a label, and labels are mutable.  A lock-file containing hashes will always resolve to the same packages (or fail).</div><br/></div></div></div></div><div id="37233306" class="c"><input type="checkbox" id="c-37233306" checked=""/><div class="controls bullet"><span class="by">planede</span><span>|</span><a href="#37232496">prev</a><span>|</span><a href="#37233358">next</a><span>|</span><label class="collapse" for="c-37233306">[-]</label><label class="expand" for="c-37233306">[1 more]</label></div><br/><div class="children"><div class="content">So, how does it handle diamonds in the dependency graph? How does it handle version compatibility? IMO these are the most interesting aspects of a package manager, other stuff are implementation detail.<p>Although there is a mention for semver at the end:<p>&gt; Decide what versioning scheme to use (Probably semver, or something like it&#x2F;enhancing it with a total order).<p>I wonder if total order is appropriate (assuming the relation &lt;= means compatibility), but it sure simplifies things. Basically throw away the major version, embed that in the name of the package if you have to.</div><br/></div></div><div id="37233358" class="c"><input type="checkbox" id="c-37233358" checked=""/><div class="controls bullet"><span class="by">peefy</span><span>|</span><a href="#37233306">prev</a><span>|</span><a href="#37232097">next</a><span>|</span><label class="collapse" for="c-37233358">[-]</label><label class="expand" for="c-37233358">[1 more]</label></div><br/><div class="children"><div class="content">Wonderful post, how about using standard OCI to unify products?<p>We have also been working hard recently on a package manager for configuring language KCL, which currently supports Git, OCI, and more.</div><br/></div></div><div id="37232097" class="c"><input type="checkbox" id="c-37232097" checked=""/><div class="controls bullet"><span class="by">deepsun</span><span>|</span><a href="#37233358">prev</a><span>|</span><a href="#37232442">next</a><span>|</span><label class="collapse" for="c-37232097">[-]</label><label class="expand" for="c-37232097">[2 more]</label></div><br/><div class="children"><div class="content">Sounds like Maven had all this solved many years ago. Yes, it cannot run arbitrary code, like NPM does, it just copies files, but the dependencies and specfiles were there from the beginning.</div><br/><div id="37232476" class="c"><input type="checkbox" id="c-37232476" checked=""/><div class="controls bullet"><span class="by">ojkelly</span><span>|</span><a href="#37232097">parent</a><span>|</span><a href="#37232442">next</a><span>|</span><label class="collapse" for="c-37232476">[-]</label><label class="expand" for="c-37232476">[1 more]</label></div><br/><div class="children"><div class="content">Not running arbitrary code is a feature, that yarn brings back to the js ecosystem.<p>It sounds nice in theory, but it impacts the soundness of the whole system.</div><br/></div></div></div></div><div id="37232442" class="c"><input type="checkbox" id="c-37232442" checked=""/><div class="controls bullet"><span class="by">mijoharas</span><span>|</span><a href="#37232097">prev</a><span>|</span><a href="#37231577">next</a><span>|</span><label class="collapse" for="c-37232442">[-]</label><label class="expand" for="c-37232442">[2 more]</label></div><br/><div class="children"><div class="content">It&#x27;s surprisingly to me that no-one has built a asdf style package manager. (I&#x27;m not talking about system package managers, their language software packages are always out of date and get installed globally instead of locally to a project).<p>Having a unified interface to a package manager per language that will use the languages registry could be really nice (I guess you&#x27;d have some core dependency management functions and agnostic ways to store and download the packages, and plugins per language that would use these common building blocks to actually do stuff?).<p>Another advantage of this could be cross language dependencies which often aren&#x27;t handled well by package managers.</div><br/><div id="37233363" class="c"><input type="checkbox" id="c-37233363" checked=""/><div class="controls bullet"><span class="by">otabdeveloper4</span><span>|</span><a href="#37232442">parent</a><span>|</span><a href="#37231577">next</a><span>|</span><label class="collapse" for="c-37233363">[-]</label><label class="expand" for="c-37233363">[1 more]</label></div><br/><div class="children"><div class="content">Nix solves that problem.<p>(While creating some new ones.)</div><br/></div></div></div></div><div id="37231577" class="c"><input type="checkbox" id="c-37231577" checked=""/><div class="controls bullet"><span class="by">BearhatBeer</span><span>|</span><a href="#37232442">prev</a><span>|</span><a href="#37231698">next</a><span>|</span><label class="collapse" for="c-37231577">[-]</label><label class="expand" for="c-37231577">[9 more]</label></div><br/><div class="children"><div class="content">I think some day rather than the current paradigm, even including declarative package managers and environments and distros, the future will be per-user and even per-app chrooting or jails, or something similar. Apple already uses something like this today. Many people who are smart about information security have one login for shopping and banking and bill pay, one for their business, and one for cruising the web or gaming or whatever. That way a breach of one doesn&#x27;t necessarily end up pwning the whole system.<p>I only have two accounts, one &quot;serious&quot; and one &quot;off hours&quot; but I still feel better protected than most people.</div><br/><div id="37231735" class="c"><input type="checkbox" id="c-37231735" checked=""/><div class="controls bullet"><span class="by">nextaccountic</span><span>|</span><a href="#37231577">parent</a><span>|</span><a href="#37231984">next</a><span>|</span><label class="collapse" for="c-37231735">[-]</label><label class="expand" for="c-37231735">[5 more]</label></div><br/><div class="children"><div class="content">&gt; Apple already uses something like this today<p>Some Linux distros too have things like this but unfortunately there is no buy-in across the ecosystem so &quot;sandboxing&quot; is done in a half-baked way.<p>The problem is when applications in general aren&#x27;t written with sandboxing in mind, and when you have to choose between apps not working properly or having a leaky sandbox, you will opt for the latter.<p>I wish some big corp bit the bullet and ported hundreds of apps to a new, sandboxed environment in Linux, while attempting to upstream the whole effort. This would necessarily involve things like fully migrating to Wayland (X11 security is awful), only granting filesystem access through distro-sanctioned file pickers (so you need some coordination among Gtk, Qt, and other toolkits), and generally having a deny-by-default policy: first you make secure, then you fix what broke.</div><br/><div id="37232193" class="c"><input type="checkbox" id="c-37232193" checked=""/><div class="controls bullet"><span class="by">zzo38computer</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37231735">parent</a><span>|</span><a href="#37231839">next</a><span>|</span><label class="collapse" for="c-37232193">[-]</label><label class="expand" for="c-37232193">[1 more]</label></div><br/><div class="children"><div class="content">There are also other problems with the way that the common sandboxing systems are working. You might need different permissions by command-line arguments and environment variables and user configuration files, and it is not designed to work with popen with user-specified commands, and they usually assume any text (including file names) is Unicode, and that some programs might access multiple files whose names are the specified one with some suffix (SQLite is one program that does this; there is the database file and the journal file). There are some other problems too.<p>I had wanted to add conditional compilation to one of my programs to work with the sandboxing but there are too many problems with the sandboxing system that it will not work, since my program requires that popen can call programs specified by the user at run time, and that some files it accesses depend on user configuration, and that it uses non-Unicode text, and accesses multiple files whose name are the same base name given on command-line arguments but with different suffixes.<p>Some programs might work even if they are not designed for the sandboxing, such as if it uses stdin&#x2F;stdout&#x2F;stderr only, and not other files. However, many programs will use other files too.</div><br/></div></div><div id="37231839" class="c"><input type="checkbox" id="c-37231839" checked=""/><div class="controls bullet"><span class="by">BearhatBeer</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37231735">parent</a><span>|</span><a href="#37232193">prev</a><span>|</span><a href="#37232362">next</a><span>|</span><label class="collapse" for="c-37231839">[-]</label><label class="expand" for="c-37231839">[1 more]</label></div><br/><div class="children"><div class="content">Firejail proves you can sandbox most anything, OpenBSD has their pledge and unveil too. I guess there&#x27;s a gradient there but each program should be written or constrained to only being able to access what it needs ideally. Per-task groups could go a long way toward solving this, they researched it in the &#x27;80s even. Just create and destroy groups on the fly to enable processes to access only what they need. Unix is flexible enough to permit experimenting here.</div><br/></div></div><div id="37232362" class="c"><input type="checkbox" id="c-37232362" checked=""/><div class="controls bullet"><span class="by">salawat</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37231735">parent</a><span>|</span><a href="#37231839">prev</a><span>|</span><a href="#37231984">next</a><span>|</span><label class="collapse" for="c-37232362">[-]</label><label class="expand" for="c-37232362">[2 more]</label></div><br/><div class="children"><div class="content">Hard pass. I don&#x27;t need Microsoft securing my calculator from me, thank you very much.<p>If I need it that badly, I&#x27;ll build it myself.</div><br/><div id="37232701" class="c"><input type="checkbox" id="c-37232701" checked=""/><div class="controls bullet"><span class="by">pmontra</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37232362">parent</a><span>|</span><a href="#37231984">next</a><span>|</span><label class="collapse" for="c-37232701">[-]</label><label class="expand" for="c-37232701">[1 more]</label></div><br/><div class="children"><div class="content">My calculator is bc -l in a terminal but I&#x27;d bet that there are calculator apps with network access to display ads, sync to the same app on other devices, save past calculations to the cloud, and get plugins.<p>I found one with some of those features and some more, with only one minute of googling <a href="https:&#x2F;&#x2F;apps.apple.com&#x2F;us&#x2F;app&#x2F;graphcalcpro2go&#x2F;id1091870099" rel="nofollow noreferrer">https:&#x2F;&#x2F;apps.apple.com&#x2F;us&#x2F;app&#x2F;graphcalcpro2go&#x2F;id1091870099</a><p>That&#x27;s for iOS but why not on Windows or Android? I&#x27;d be surprised to find one like that on Linux.</div><br/></div></div></div></div></div></div><div id="37231984" class="c"><input type="checkbox" id="c-37231984" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#37231577">parent</a><span>|</span><a href="#37231735">prev</a><span>|</span><a href="#37231698">next</a><span>|</span><label class="collapse" for="c-37231984">[-]</label><label class="expand" for="c-37231984">[3 more]</label></div><br/><div class="children"><div class="content">Like silverblue with toolbox?</div><br/><div id="37232020" class="c"><input type="checkbox" id="c-37232020" checked=""/><div class="controls bullet"><span class="by">BearhatBeer</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37231984">parent</a><span>|</span><a href="#37231698">next</a><span>|</span><label class="collapse" for="c-37232020">[-]</label><label class="expand" for="c-37232020">[2 more]</label></div><br/><div class="children"><div class="content">Something like Silverblue will only ever work with a rigid set in stone ROM-friendly base. You can&#x27;t even do fixes with that, so Linux is right out.<p>Lisp on bare metal, FORTH, anything. BASIC. It has to be small.</div><br/><div id="37233070" class="c"><input type="checkbox" id="c-37233070" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#37231577">root</a><span>|</span><a href="#37232020">parent</a><span>|</span><a href="#37231698">next</a><span>|</span><label class="collapse" for="c-37233070">[-]</label><label class="expand" for="c-37233070">[1 more]</label></div><br/><div class="children"><div class="content">Er, what? SB handles updates fine. The base&#x2F;host OS is separate from what goes on in the containers anyways.</div><br/></div></div></div></div></div></div></div></div><div id="37231698" class="c"><input type="checkbox" id="c-37231698" checked=""/><div class="controls bullet"><span class="by">larusso</span><span>|</span><a href="#37231577">prev</a><span>|</span><a href="#37232446">next</a><span>|</span><label class="collapse" for="c-37231698">[-]</label><label class="expand" for="c-37231698">[3 more]</label></div><br/><div class="children"><div class="content">Awesome post! I worked with a bunch of package managers over the years and one can see that this design got inspired by the hood parts of a few I know.<p>The only design part I don‘t really like is the ‚latest‘ version specifier in the spec file. Which moves the declaration what the latest version is to the hosted location (in the example GitHub via GitHub API) paired with the fact that the checksums are also fetched rather than being part of the spec. This makes no sense for me. The spec needs to be versioned or better the spec is the actual location to declare a release. I kind of understand where the desire comes from to have a floating spec. Makes the publish process easier since one only creates a GitHub release in this case. But I would still argue that explicitly creating a new version of the spec for each version with baked checksums is better. The benefit for me would be that one could create a hash for each spec version for instance and use that internally for instance.</div><br/><div id="37232316" class="c"><input type="checkbox" id="c-37232316" checked=""/><div class="controls bullet"><span class="by">friendzis</span><span>|</span><a href="#37231698">parent</a><span>|</span><a href="#37232446">next</a><span>|</span><label class="collapse" for="c-37232316">[-]</label><label class="expand" for="c-37232316">[2 more]</label></div><br/><div class="children"><div class="content">Probably the simplest version of a &quot;package manager&quot; are git submodules. Pointing submodule to `master` is effectively the same thing as pointing a &quot;real&quot; package manager to `latest`. This is trunk based development, however you implement it.<p>One could easily argue that floating versions are considered harmful for releases outside of development team and should always be pinned, but on the other hand it is hard to argue against support for floating versions in development. As much as I dislike floating versions, I am not aware of any other way to <i>force</i> changes downstream.</div><br/><div id="37232478" class="c"><input type="checkbox" id="c-37232478" checked=""/><div class="controls bullet"><span class="by">larusso</span><span>|</span><a href="#37231698">root</a><span>|</span><a href="#37232316">parent</a><span>|</span><a href="#37232446">next</a><span>|</span><label class="collapse" for="c-37232478">[-]</label><label class="expand" for="c-37232478">[1 more]</label></div><br/><div class="children"><div class="content">Brew has the —head flag where one can instruct to build the latest commit from the repo. But the spec&#x2F;Formular needs to set a head to pull from.</div><br/></div></div></div></div></div></div><div id="37232446" class="c"><input type="checkbox" id="c-37232446" checked=""/><div class="controls bullet"><span class="by">riffraff</span><span>|</span><a href="#37231698">prev</a><span>|</span><a href="#37231580">next</a><span>|</span><label class="collapse" for="c-37232446">[-]</label><label class="expand" for="c-37232446">[2 more]</label></div><br/><div class="children"><div class="content">Isn&#x27;t this missing the SQLite version?<p>Are SQLite extensions guaranteed to work across different SQLite installs?</div><br/><div id="37232781" class="c"><input type="checkbox" id="c-37232781" checked=""/><div class="controls bullet"><span class="by">matharmin</span><span>|</span><a href="#37232446">parent</a><span>|</span><a href="#37231580">next</a><span>|</span><label class="collapse" for="c-37232781">[-]</label><label class="expand" for="c-37232781">[1 more]</label></div><br/><div class="children"><div class="content">SQLite is quite good at staying backwards compatible, and this includes the APIs exposed to extensions, but extensions could definitely have a minimum SQLite version.</div><br/></div></div></div></div><div id="37231580" class="c"><input type="checkbox" id="c-37231580" checked=""/><div class="controls bullet"><span class="by">dclowd9901</span><span>|</span><a href="#37232446">prev</a><span>|</span><a href="#37231543">next</a><span>|</span><label class="collapse" for="c-37231580">[-]</label><label class="expand" for="c-37231580">[1 more]</label></div><br/><div class="children"><div class="content">Man, I really wish frontend package management could be this simple, but with a system that ultimately ships bytes over the wire, we have to not only massage the dough with chopsticks (insofar as try to reduce our dependency tree with weak, feckless tools), but also, with the sheer number of transitive dependencies for each package addition, it’s almost impossible to really know what’s going on with your dependencies unless you write plug-in after plug-in.</div><br/></div></div><div id="37231543" class="c"><input type="checkbox" id="c-37231543" checked=""/><div class="controls bullet"><span class="by">forrestthewoods</span><span>|</span><a href="#37231580">prev</a><span>|</span><a href="#37220954">next</a><span>|</span><label class="collapse" for="c-37231543">[-]</label><label class="expand" for="c-37231543">[3 more]</label></div><br/><div class="children"><div class="content">Wonderful post! I&#x27;ve written a couple of packager manager like things over the years. Although they&#x27;ve all been internal-only which gives some flexibility.<p>&gt; I like the idea of allowing both project and global scope<p>Yikes! Hard no from me. Globals are pure evil. Avoid like the plague. Environment variables too. Kill them all with fire.<p>&gt; what if the user wants to reinstall the packages on another machine or CI server? That’s where the lockfile comes in<p>I&#x27;ve typically bypassed the need for a lockfile by simply checking in the dependencies. Dependencies belong in version control! That&#x27;s a rant for another day.<p>Treating the packages folder as source of truth is basically the equivalent I think?<p>&gt; I understand that dropping dependencies altogether may not be something you are ready to accept.<p>Nice. A corollary to this is that if all your packages are internal then you can simply disallow dependency graphs that want different versions of the same package. Simply bump and fix-up all version number dependencies for all packages.<p>The basically means &quot;all packages play nicely on latest version&quot;. Which when all the packages live in a monorepo is perfectly plausible. Totally doesn&#x27;t work for public package managers, but that&#x27;s a different story.</div><br/><div id="37232327" class="c"><input type="checkbox" id="c-37232327" checked=""/><div class="controls bullet"><span class="by">verdverm</span><span>|</span><a href="#37231543">parent</a><span>|</span><a href="#37231652">next</a><span>|</span><label class="collapse" for="c-37232327">[-]</label><label class="expand" for="c-37232327">[1 more]</label></div><br/><div class="children"><div class="content">It totally works for Go with MVS, which bumps a lot of versions behind the scenes for you.</div><br/></div></div><div id="37231652" class="c"><input type="checkbox" id="c-37231652" checked=""/><div class="controls bullet"><span class="by">RajT88</span><span>|</span><a href="#37231543">parent</a><span>|</span><a href="#37232327">prev</a><span>|</span><a href="#37220954">next</a><span>|</span><label class="collapse" for="c-37231652">[-]</label><label class="expand" for="c-37231652">[1 more]</label></div><br/><div class="children"><div class="content">&gt;  Environment variables too. Kill them all with fire.<p>I feel this way about host file entries.<p>It is shocking how common they remain, and not just in QA&#x2F;Dev.</div><br/></div></div></div></div><div id="37220954" class="c"><input type="checkbox" id="c-37220954" checked=""/><div class="controls bullet"><span class="by">celiktom</span><span>|</span><a href="#37231543">prev</a><span>|</span><label class="collapse" for="c-37220954">[-]</label><label class="expand" for="c-37220954">[4 more]</label></div><br/><div class="children"><div class="content">Writing a package manager is not one of the most common programming tasks. After all, there are many out-of-the-box ones available.</div><br/><div id="37231316" class="c"><input type="checkbox" id="c-37231316" checked=""/><div class="controls bullet"><span class="by">3np</span><span>|</span><a href="#37220954">parent</a><span>|</span><a href="#37231711">next</a><span>|</span><label class="collapse" for="c-37231316">[-]</label><label class="expand" for="c-37231316">[1 more]</label></div><br/><div class="children"><div class="content">These copy-pasted one-liners aren&#x27;t useful. Skip them.</div><br/></div></div><div id="37231711" class="c"><input type="checkbox" id="c-37231711" checked=""/><div class="controls bullet"><span class="by">000ooo000</span><span>|</span><a href="#37220954">parent</a><span>|</span><a href="#37231316">prev</a><span>|</span><label class="collapse" for="c-37231711">[-]</label><label class="expand" for="c-37231711">[2 more]</label></div><br/><div class="children"><div class="content">Imagine what&#x27;d we be using for package management today if package manager &gt;= #2 author said &quot;you know what, one already exists&quot;.</div><br/><div id="37232174" class="c"><input type="checkbox" id="c-37232174" checked=""/><div class="controls bullet"><span class="by">jsunderland323</span><span>|</span><a href="#37220954">root</a><span>|</span><a href="#37231711">parent</a><span>|</span><label class="collapse" for="c-37232174">[-]</label><label class="expand" for="c-37232174">[1 more]</label></div><br/><div class="children"><div class="content">This is the package manager paradox. The problem is multiple package managers but to address it we build more package managers.</div><br/></div></div></div></div></div></div></div></div></div></div></div></body></html>