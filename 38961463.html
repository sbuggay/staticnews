<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1705050055346" as="style"/><link rel="stylesheet" href="styles.css?v=1705050055346"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://pganalyze.com/blog/5mins-postgres-17-incremental-backups">Postgres Incremental Backup</a> <span class="domain">(<a href="https://pganalyze.com">pganalyze.com</a>)</span></div><div class="subtext"><span>code_reader</span> | <span>31 comments</span></div><br/><div><div id="38964724" class="c"><input type="checkbox" id="c-38964724" checked=""/><div class="controls bullet"><span class="by">lfittl</span><span>|</span><a href="#38964554">next</a><span>|</span><label class="collapse" for="c-38964724">[-]</label><label class="expand" for="c-38964724">[3 more]</label></div><br/><div class="children"><div class="content">(OP here, happy to see this on HN!)<p>If you&#x27;re interested in this topic, Robert Haas (the author&#x2F;committer of the feature) also wrote two posts after I published this, which talk more about incremental backup:<p><a href="http:&#x2F;&#x2F;rhaas.blogspot.com&#x2F;2024&#x2F;01&#x2F;incremental-backup-what-to-copy.html" rel="nofollow">http:&#x2F;&#x2F;rhaas.blogspot.com&#x2F;2024&#x2F;01&#x2F;incremental-backup-what-to...</a><p><a href="http:&#x2F;&#x2F;rhaas.blogspot.com&#x2F;2024&#x2F;01&#x2F;incremental-backups-evergreen-and-other.html" rel="nofollow">http:&#x2F;&#x2F;rhaas.blogspot.com&#x2F;2024&#x2F;01&#x2F;incremental-backups-evergr...</a></div><br/><div id="38965262" class="c"><input type="checkbox" id="c-38965262" checked=""/><div class="controls bullet"><span class="by">skrause</span><span>|</span><a href="#38964724">parent</a><span>|</span><a href="#38964554">next</a><span>|</span><label class="collapse" for="c-38965262">[-]</label><label class="expand" for="c-38965262">[2 more]</label></div><br/><div class="children"><div class="content">A side note: Your RSS feed <a href="https:&#x2F;&#x2F;pganalyze.com&#x2F;feed.xml" rel="nofollow">https:&#x2F;&#x2F;pganalyze.com&#x2F;feed.xml</a> misses most of your blog articles.<p>I&#x27;m actually subscribed to your blog in my RSS reader, but I completely missed this article (any many others) when it was published because it didn&#x27;t show up in the RSS feed.</div><br/><div id="38965357" class="c"><input type="checkbox" id="c-38965357" checked=""/><div class="controls bullet"><span class="by">lfittl</span><span>|</span><a href="#38964724">root</a><span>|</span><a href="#38965262">parent</a><span>|</span><a href="#38964554">next</a><span>|</span><label class="collapse" for="c-38965357">[-]</label><label class="expand" for="c-38965357">[1 more]</label></div><br/><div class="children"><div class="content">Good point - its set up this way since we intentionally don&#x27;t syndicate the 5mins of Postgres episodes to Planet Postgres, but I could see the benefit of having a complete feed that includes everything, for those subscribing via RSS readers. Will see what I can do :)</div><br/></div></div></div></div></div></div><div id="38964554" class="c"><input type="checkbox" id="c-38964554" checked=""/><div class="controls bullet"><span class="by">theanirudh</span><span>|</span><a href="#38964724">prev</a><span>|</span><a href="#38962318">next</a><span>|</span><label class="collapse" for="c-38964554">[-]</label><label class="expand" for="c-38964554">[8 more]</label></div><br/><div class="children"><div class="content">A very much needed feature. Had a nightmare scenario in my previous startup where Google Cloud just killed all our servers and yanked out access. We got back access in an hour or so, but we had to recreate all the servers. At that point we were taking Postgres base backups (to Google Cloud Storage) daily at 2:30 AM. The incident happened at around 15:00 so we had to replay the WAL for the period of about 12.5 hours. That was the slowest part and it took about 6-7 hours to get the DB back up. After that incident we started taking base backups every 6 hours.</div><br/><div id="38965496" class="c"><input type="checkbox" id="c-38965496" checked=""/><div class="controls bullet"><span class="by">tticvs</span><span>|</span><a href="#38964554">parent</a><span>|</span><a href="#38965623">next</a><span>|</span><label class="collapse" for="c-38965496">[-]</label><label class="expand" for="c-38965496">[1 more]</label></div><br/><div class="children"><div class="content">Did you have any recourse against Google Cloud? Did you ever find out why they did that?</div><br/></div></div><div id="38965623" class="c"><input type="checkbox" id="c-38965623" checked=""/><div class="controls bullet"><span class="by">winrid</span><span>|</span><a href="#38964554">parent</a><span>|</span><a href="#38965496">prev</a><span>|</span><a href="#38964992">next</a><span>|</span><label class="collapse" for="c-38965623">[-]</label><label class="expand" for="c-38965623">[1 more]</label></div><br/><div class="children"><div class="content">wow! how big was the WAL? what kinda IOPS&#x2F;disks are you using?</div><br/></div></div><div id="38964992" class="c"><input type="checkbox" id="c-38964992" checked=""/><div class="controls bullet"><span class="by">teaearlgraycold</span><span>|</span><a href="#38964554">parent</a><span>|</span><a href="#38965623">prev</a><span>|</span><a href="#38962318">next</a><span>|</span><label class="collapse" for="c-38964992">[-]</label><label class="expand" for="c-38964992">[5 more]</label></div><br/><div class="children"><div class="content">&gt; Google Cloud just killed all our servers<p>&gt; we were taking Postgres base backups (to Google Cloud Storage)<p>Rule #1 of backups - <i>do not host backups in the same location as the primary</i></div><br/><div id="38965104" class="c"><input type="checkbox" id="c-38965104" checked=""/><div class="controls bullet"><span class="by">ddorian43</span><span>|</span><a href="#38964554">root</a><span>|</span><a href="#38964992">parent</a><span>|</span><a href="#38965533">next</a><span>|</span><label class="collapse" for="c-38965104">[-]</label><label class="expand" for="c-38965104">[3 more]</label></div><br/><div class="children"><div class="content">The egrees fees will be bigger than your db cost.</div><br/><div id="38965284" class="c"><input type="checkbox" id="c-38965284" checked=""/><div class="controls bullet"><span class="by">silon42</span><span>|</span><a href="#38964554">root</a><span>|</span><a href="#38965104">parent</a><span>|</span><a href="#38965547">next</a><span>|</span><label class="collapse" for="c-38965284">[-]</label><label class="expand" for="c-38965284">[1 more]</label></div><br/><div class="children"><div class="content">Yes, maybe (some kind of diff&#x2F;sync could maybe help), but this means using such a cloud is a bad IT practice.</div><br/></div></div><div id="38965547" class="c"><input type="checkbox" id="c-38965547" checked=""/><div class="controls bullet"><span class="by">scoot</span><span>|</span><a href="#38964554">root</a><span>|</span><a href="#38965104">parent</a><span>|</span><a href="#38965284">prev</a><span>|</span><a href="#38965533">next</a><span>|</span><label class="collapse" for="c-38965547">[-]</label><label class="expand" for="c-38965547">[1 more]</label></div><br/><div class="children"><div class="content">Which is why enterprise backup solutions offer deduplication and compression (and encryption, and immutability, and...)</div><br/></div></div></div></div><div id="38965533" class="c"><input type="checkbox" id="c-38965533" checked=""/><div class="controls bullet"><span class="by">scoot</span><span>|</span><a href="#38964554">root</a><span>|</span><a href="#38964992">parent</a><span>|</span><a href="#38965104">prev</a><span>|</span><a href="#38962318">next</a><span>|</span><label class="collapse" for="c-38965533">[-]</label><label class="expand" for="c-38965533">[1 more]</label></div><br/><div class="children"><div class="content">That&#x27;s incorrect. You definitely <i>do</i> want backups in the same location as production if possible to enable rapid restore. You just don&#x27;t want that to be your only copy.<p>The canonical strategy is the 3-2-1 rule: three copies, two different media, one offsite; but there are variations, so I&#x27;d consider this the minimum.</div><br/></div></div></div></div></div></div><div id="38962318" class="c"><input type="checkbox" id="c-38962318" checked=""/><div class="controls bullet"><span class="by">aeyes</span><span>|</span><a href="#38964554">prev</a><span>|</span><a href="#38962872">next</a><span>|</span><label class="collapse" for="c-38962318">[-]</label><label class="expand" for="c-38962318">[2 more]</label></div><br/><div class="children"><div class="content">Awesome feature and a great demo as well.<p>I have been missing this for the last....15 years. I hope that it will make it into the final release.<p>I wonder how much time combining the backups will take If you have 100 or 500GB, the tests didn&#x27;t address this. I might have to spin up an instance to try it out.</div><br/></div></div><div id="38962872" class="c"><input type="checkbox" id="c-38962872" checked=""/><div class="controls bullet"><span class="by">endisneigh</span><span>|</span><a href="#38962318">prev</a><span>|</span><a href="#38963397">next</a><span>|</span><label class="collapse" for="c-38962872">[-]</label><label class="expand" for="c-38962872">[1 more]</label></div><br/><div class="children"><div class="content">Incremental backup (without the useful wal summarizer in this case) is an interesting thing to try to implement from scratch.<p>I’ll have to read how the summarizer works specifically</div><br/></div></div><div id="38963397" class="c"><input type="checkbox" id="c-38963397" checked=""/><div class="controls bullet"><span class="by">MuffinFlavored</span><span>|</span><a href="#38962872">prev</a><span>|</span><a href="#38963128">next</a><span>|</span><label class="collapse" for="c-38963397">[-]</label><label class="expand" for="c-38963397">[8 more]</label></div><br/><div class="children"><div class="content">I wonder what stuff like this means in terms of electrical impact around the world at scale.<p>I&#x27;m being dramatic obviously but like... less CPU cycles, less network bandwidth, etc. etc.<p>If adopted by top 100 &quot;large&quot; database&#x2F;operations, is it as much as like 100 people giving up their gas&#x2F;petrol&#x2F;diesel car?</div><br/><div id="38964960" class="c"><input type="checkbox" id="c-38964960" checked=""/><div class="controls bullet"><span class="by">mosselman</span><span>|</span><a href="#38963397">parent</a><span>|</span><a href="#38963416">next</a><span>|</span><label class="collapse" for="c-38964960">[-]</label><label class="expand" for="c-38964960">[2 more]</label></div><br/><div class="children"><div class="content">I did a thought experiment with made up numbers. I just woke up so forgive me if my numbers don’t add up. At least they can serve as ballpark numbers.<p>Let’s say a full backup takes 3 hours and an incremental one 3 minutes.<p>Let’s say I want at most 3 hours of lag in my backups. That would mean 3 hours every 3 hours. That is about 720 hours per month for a full backup or 720 minutes (12 hours) for incremental backups. Let’s say we
Still do a full one once a day then that is still 102 hours per month in total.<p>Even if you do 1 incremental per hour you’d end up at 36 hours a month. If 3 minutes were true for the every 3 hour scenario, the every 1 hour scenario would also mean shorter backups so maybe 1 minute, which adds up to 12 hours.<p>All this to say that it might be more efficient.</div><br/><div id="38965570" class="c"><input type="checkbox" id="c-38965570" checked=""/><div class="controls bullet"><span class="by">scoot</span><span>|</span><a href="#38963397">root</a><span>|</span><a href="#38964960">parent</a><span>|</span><a href="#38963416">next</a><span>|</span><label class="collapse" for="c-38965570">[-]</label><label class="expand" for="c-38965570">[1 more]</label></div><br/><div class="children"><div class="content">&gt; Let’s say I want at most 3 hours of lag<p>AKA Recovery Point Objective (RPO)</div><br/></div></div></div></div><div id="38963416" class="c"><input type="checkbox" id="c-38963416" checked=""/><div class="controls bullet"><span class="by">peterfirefly</span><span>|</span><a href="#38963397">parent</a><span>|</span><a href="#38964960">prev</a><span>|</span><a href="#38964807">next</a><span>|</span><label class="collapse" for="c-38963416">[-]</label><label class="expand" for="c-38963416">[3 more]</label></div><br/><div class="children"><div class="content"><a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Jevons_paradox" rel="nofollow">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Jevons_paradox</a></div><br/><div id="38964421" class="c"><input type="checkbox" id="c-38964421" checked=""/><div class="controls bullet"><span class="by">flockonus</span><span>|</span><a href="#38963397">root</a><span>|</span><a href="#38963416">parent</a><span>|</span><a href="#38964807">next</a><span>|</span><label class="collapse" for="c-38964421">[-]</label><label class="expand" for="c-38964421">[2 more]</label></div><br/><div class="children"><div class="content">Glad I&#x27;ve learned about this fascinating effect, but it doesn&#x27;t seem reasonable that such a niche improvement on Postgresql backup would have an impact on the price of electricity or another resource.</div><br/><div id="38964555" class="c"><input type="checkbox" id="c-38964555" checked=""/><div class="controls bullet"><span class="by">fastball</span><span>|</span><a href="#38963397">root</a><span>|</span><a href="#38964421">parent</a><span>|</span><a href="#38964807">next</a><span>|</span><label class="collapse" for="c-38964555">[-]</label><label class="expand" for="c-38964555">[1 more]</label></div><br/><div class="children"><div class="content">No, but you could imagine a situation where a feature added to a database makes people more likely to use that database, even in places where maybe a &quot;lighter weight&quot; database (e.g. SQLite) would&#x27;ve been good enough, therefore increasing electricity usage overall.</div><br/></div></div></div></div></div></div><div id="38964807" class="c"><input type="checkbox" id="c-38964807" checked=""/><div class="controls bullet"><span class="by">fbdab103</span><span>|</span><a href="#38963397">parent</a><span>|</span><a href="#38963416">prev</a><span>|</span><a href="#38963949">next</a><span>|</span><label class="collapse" for="c-38964807">[-]</label><label class="expand" for="c-38964807">[1 more]</label></div><br/><div class="children"><div class="content">I think about this every time I see my corporate laptop spinning up because of bloated malware detection software, Teams, OneDrive, etc all seemingly unoptimized and burning resources across hundreds of millions of machines worldwide.</div><br/></div></div><div id="38963949" class="c"><input type="checkbox" id="c-38963949" checked=""/><div class="controls bullet"><span class="by">devnonymous</span><span>|</span><a href="#38963397">parent</a><span>|</span><a href="#38964807">prev</a><span>|</span><a href="#38963128">next</a><span>|</span><label class="collapse" for="c-38963949">[-]</label><label class="expand" for="c-38963949">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m willing to bet that beyond a certain threshold there&#x27;s no use for an incremental backup. You either would use (delayed) replication[1] to have an &#x27;incremental&#x27; copy or would take full backups. I don&#x27;t think any large database users rushing to use incremental backups when they have full redundancy.<p>[1] for example <a href="https:&#x2F;&#x2F;about.gitlab.com&#x2F;blog&#x2F;2019&#x2F;02&#x2F;13&#x2F;delayed-replication-for-disaster-recovery-with-postgresql&#x2F;" rel="nofollow">https:&#x2F;&#x2F;about.gitlab.com&#x2F;blog&#x2F;2019&#x2F;02&#x2F;13&#x2F;delayed-replication...</a></div><br/></div></div></div></div><div id="38963128" class="c"><input type="checkbox" id="c-38963128" checked=""/><div class="controls bullet"><span class="by">donor20</span><span>|</span><a href="#38963397">prev</a><span>|</span><a href="#38962991">next</a><span>|</span><label class="collapse" for="c-38963128">[-]</label><label class="expand" for="c-38963128">[2 more]</label></div><br/><div class="children"><div class="content">Fantastic! I’m assuming you can wal replay on the incremental to get right where you want</div><br/><div id="38963831" class="c"><input type="checkbox" id="c-38963831" checked=""/><div class="controls bullet"><span class="by">Twisell</span><span>|</span><a href="#38963128">parent</a><span>|</span><a href="#38962991">next</a><span>|</span><label class="collapse" for="c-38963831">[-]</label><label class="expand" for="c-38963831">[1 more]</label></div><br/><div class="children"><div class="content">I don&#x27;t think so because the smaller size is achieved by ignoring (= summarizing) changes between each snapshots.<p>To do WAL replay (= Point In Time Recovery PITR) you&#x27;ll still need the full incremental WAL files that take up more space (and is already available in PG since like ten years I think).<p>PS:Usually you&#x27;ll also take one full pg_basebackup snapshot on regular basis to avoid replaying too much and to discard older snapshot.<p>So maybe the gain would be to combine theses process. Keep incremental WAL for short term PITR but apply incremental backup to snapshot to reduce long term backup size.<p>Anyway this is a really cool mew option!</div><br/></div></div></div></div><div id="38962991" class="c"><input type="checkbox" id="c-38962991" checked=""/><div class="controls bullet"><span class="by">genman</span><span>|</span><a href="#38963128">prev</a><span>|</span><a href="#38963524">next</a><span>|</span><label class="collapse" for="c-38962991">[-]</label><label class="expand" for="c-38962991">[2 more]</label></div><br/><div class="children"><div class="content">To summarize. This is a new possible feature for the upcoming release. No, you don&#x27;t have only full backups with Postgres right now - it is possible to perform incremental backups using Write Ahead Log (WAL), but with WAL you have to replay all the changes one by one while the new feature is a real diff meaning that backups will be smaller and faster to apply.</div><br/><div id="38963240" class="c"><input type="checkbox" id="c-38963240" checked=""/><div class="controls bullet"><span class="by">sroussey</span><span>|</span><a href="#38962991">parent</a><span>|</span><a href="#38963524">next</a><span>|</span><label class="collapse" for="c-38963240">[-]</label><label class="expand" for="c-38963240">[1 more]</label></div><br/><div class="children"><div class="content">By watching which records the WAL changed since last backup, it saves a list of records to back up as incremental. Neat.<p>Now if your db works like append only, this may need t be as big as a savings as someone who updates the same records a lot (as at incremental backup time it only needs to save the final values of those records).<p>This could be used in replication topographies and scenarios. Maybe PG 18.</div><br/></div></div></div></div><div id="38963524" class="c"><input type="checkbox" id="c-38963524" checked=""/><div class="controls bullet"><span class="by">lucw</span><span>|</span><a href="#38962991">prev</a><span>|</span><label class="collapse" for="c-38963524">[-]</label><label class="expand" for="c-38963524">[4 more]</label></div><br/><div class="children"><div class="content">question: how does pgbackrest do incremental backup right now if postgres doesn&#x27;t yet support it ?</div><br/><div id="38963601" class="c"><input type="checkbox" id="c-38963601" checked=""/><div class="controls bullet"><span class="by">brand</span><span>|</span><a href="#38963524">parent</a><span>|</span><a href="#38963578">next</a><span>|</span><label class="collapse" for="c-38963601">[-]</label><label class="expand" for="c-38963601">[1 more]</label></div><br/><div class="children"><div class="content">pgbackrest works purely at the file level, by looking at checksums. It’s rather primitive by comparison.</div><br/></div></div><div id="38963581" class="c"><input type="checkbox" id="c-38963581" checked=""/><div class="controls bullet"><span class="by">pilif</span><span>|</span><a href="#38963524">parent</a><span>|</span><a href="#38963578">prev</a><span>|</span><label class="collapse" for="c-38963581">[-]</label><label class="expand" for="c-38963581">[1 more]</label></div><br/><div class="children"><div class="content">By keeping the whole WAL.<p>The incremental backup would be just the WAL segments excluding the base backup.<p>With this new feature, the WAL segments you need to store are much, much smaller.</div><br/></div></div></div></div></div></div></div></div></div></body></html>