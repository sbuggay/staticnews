<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1702285263628" as="style"/><link rel="stylesheet" href="styles.css?v=1702285263628"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://ayende.com/blog/198241-B/the-subtleties-of-proper-b-tree-implementation">The subtleties of proper B+Tree implementation</a> <span class="domain">(<a href="https://ayende.com">ayende.com</a>)</span></div><div class="subtext"><span>tim_sw</span> | <span>35 comments</span></div><br/><div><div id="38598464" class="c"><input type="checkbox" id="c-38598464" checked=""/><div class="controls bullet"><span class="by">makmanalp</span><span>|</span><a href="#38595123">next</a><span>|</span><label class="collapse" for="c-38598464">[-]</label><label class="expand" for="c-38598464">[2 more]</label></div><br/><div class="children"><div class="content">If you&#x27;re interested in B+Trees, and especially if you find yourself implementing one, go read this: <a href="https:&#x2F;&#x2F;w6113.github.io&#x2F;files&#x2F;papers&#x2F;btreesurvey-graefe.pdf" rel="nofollow noreferrer">https:&#x2F;&#x2F;w6113.github.io&#x2F;files&#x2F;papers&#x2F;btreesurvey-graefe.pdf</a><p>I certainly haven&#x27;t read the entire thing but gosh there&#x27;s some good bits. E.g. &quot;B-trees Versus Hash Indexes&quot; - tons of insights jampacked together into a couple pages for anyone who hasn&#x27;t already been exposed to B-trees in detail (e.g. in a research context vs the usual data structures class)</div><br/><div id="38598719" class="c"><input type="checkbox" id="c-38598719" checked=""/><div class="controls bullet"><span class="by">jasonwatkinspdx</span><span>|</span><a href="#38598464">parent</a><span>|</span><a href="#38595123">next</a><span>|</span><label class="collapse" for="c-38598719">[-]</label><label class="expand" for="c-38598719">[1 more]</label></div><br/><div class="children"><div class="content">Yeah, this paper&#x2F;book has a lot of great information about the details that your typical textbook explanation will never get into.</div><br/></div></div></div></div><div id="38595123" class="c"><input type="checkbox" id="c-38595123" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#38598464">prev</a><span>|</span><a href="#38594888">next</a><span>|</span><label class="collapse" for="c-38595123">[-]</label><label class="expand" for="c-38595123">[10 more]</label></div><br/><div class="children"><div class="content">Note: In most cases you don&#x27;t want to split pages prior to insertion as is being done here.  Instead, you want to insert data first, and then restore the page size invariants at the end (prior to committing the operation &#x2F; writing to disk &#x2F; etc).  If you&#x27;re doing multiple operations at once (e.g. adding new keys and deleting others) it may turn out that you can avoid the expensive page-splitting operation by postponing it.</div><br/><div id="38595951" class="c"><input type="checkbox" id="c-38595951" checked=""/><div class="controls bullet"><span class="by">koverstreet</span><span>|</span><a href="#38595123">parent</a><span>|</span><a href="#38594888">next</a><span>|</span><label class="collapse" for="c-38595951">[-]</label><label class="expand" for="c-38595951">[9 more]</label></div><br/><div class="children"><div class="content">No, you don&#x27;t. That&#x27;ll add expensive memory reallocations; it may let you avoid the split operation but then that isn&#x27;t worth it because you&#x27;ve added a nasty performance cliff to your insert case - you&#x27;ll either be doing the memory allocation repeatedly, or you&#x27;ll waste a ton of memory when your buffer is bigger than your on disk node size.</div><br/><div id="38596182" class="c"><input type="checkbox" id="c-38596182" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38595951">parent</a><span>|</span><a href="#38596250">next</a><span>|</span><label class="collapse" for="c-38596182">[-]</label><label class="expand" for="c-38596182">[7 more]</label></div><br/><div class="children"><div class="content">For my workload it&#x27;s optimal to keep working nodes deserialized anyway.  YMMV but what I&#x27;m doing gets me over a million operations per second -- 1 Gbps of requests -- on a single CPU so I don&#x27;t think I&#x27;m going far wrong.<p>EDIT: I just noticed you&#x27;re the bcachefs author.  I&#x27;m guessing you&#x27;re dealing with much larger key&#x2F;value pairs than I am (40+40)?</div><br/><div id="38596494" class="c"><input type="checkbox" id="c-38596494" checked=""/><div class="controls bullet"><span class="by">koverstreet</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38596182">parent</a><span>|</span><a href="#38596241">next</a><span>|</span><label class="collapse" for="c-38596494">[-]</label><label class="expand" for="c-38596494">[3 more]</label></div><br/><div class="children"><div class="content">No, that&#x27;s a typical size for bcachefs as well.<p>But I&#x27;ve had to optimize for memory usage, performance when working set does not fit into ram - we also don&#x27;t have a serialize&#x2F;deserialize step, that will really hurt you when working set doesn&#x27;t fit in ram.<p>You want to validate when you&#x27;re reading in a btree node, but you want to keep that as cheap as possible.<p>For avoiding the serialize&#x2F;deserialize, the thing to use now would be Cap&#x27;n Proto.</div><br/><div id="38596640" class="c"><input type="checkbox" id="c-38596640" checked=""/><div class="controls bullet"><span class="by">cperciva</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38596494">parent</a><span>|</span><a href="#38596241">next</a><span>|</span><label class="collapse" for="c-38596640">[-]</label><label class="expand" for="c-38596640">[2 more]</label></div><br/><div class="children"><div class="content">Ah, that would explain it.  Yeah, I have a total datastore size which is out of core, but the working set is generally in core... partly because I can use all the RAM on the system if I want to, whereas filesystems are (usually!) expected to occupy just a portion of the system memory.<p>FWIW, my &quot;deserialize&quot; doesn&#x27;t involve copying all the data -- I just construct pointers into the (serialized) page.  Serializing has to copy data though.</div><br/><div id="38597318" class="c"><input type="checkbox" id="c-38597318" checked=""/><div class="controls bullet"><span class="by">valenterry</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38596640">parent</a><span>|</span><a href="#38596241">next</a><span>|</span><label class="collapse" for="c-38597318">[-]</label><label class="expand" for="c-38597318">[1 more]</label></div><br/><div class="children"><div class="content">Just wanted to say, I really enjoyed reading your guys conversation, since I barely never do low-level optimizations like that. Very interesting, thanks for sharing your thoughts!</div><br/></div></div></div></div></div></div><div id="38596241" class="c"><input type="checkbox" id="c-38596241" checked=""/><div class="controls bullet"><span class="by">7e</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38596182">parent</a><span>|</span><a href="#38596494">prev</a><span>|</span><a href="#38596250">next</a><span>|</span><label class="collapse" for="c-38596241">[-]</label><label class="expand" for="c-38596241">[3 more]</label></div><br/><div class="children"><div class="content">Well, bcachefs is currently the slowest of all Linux filesystems.</div><br/><div id="38597542" class="c"><input type="checkbox" id="c-38597542" checked=""/><div class="controls bullet"><span class="by">7e</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38596241">parent</a><span>|</span><a href="#38596250">next</a><span>|</span><label class="collapse" for="c-38597542">[-]</label><label class="expand" for="c-38597542">[2 more]</label></div><br/><div class="children"><div class="content">See <a href="https:&#x2F;&#x2F;www.phoronix.com&#x2F;review&#x2F;bcachefs-linux-67" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.phoronix.com&#x2F;review&#x2F;bcachefs-linux-67</a>.</div><br/><div id="38597945" class="c"><input type="checkbox" id="c-38597945" checked=""/><div class="controls bullet"><span class="by">magicalhippo</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38597542">parent</a><span>|</span><a href="#38596250">next</a><span>|</span><label class="collapse" for="c-38597945">[-]</label><label class="expand" for="c-38597945">[1 more]</label></div><br/><div class="children"><div class="content">Probably more interesting to consider the follow-up article[1] after some debug code was disabled and such.<p>[1]: <a href="https:&#x2F;&#x2F;www.phoronix.com&#x2F;review&#x2F;bcachefs-benchmarks-linux67" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.phoronix.com&#x2F;review&#x2F;bcachefs-benchmarks-linux67</a></div><br/></div></div></div></div></div></div></div></div><div id="38596250" class="c"><input type="checkbox" id="c-38596250" checked=""/><div class="controls bullet"><span class="by">apavlo</span><span>|</span><a href="#38595123">root</a><span>|</span><a href="#38595951">parent</a><span>|</span><a href="#38596182">prev</a><span>|</span><a href="#38594888">next</a><span>|</span><label class="collapse" for="c-38596250">[-]</label><label class="expand" for="c-38596250">[1 more]</label></div><br/><div class="children"><div class="content">&gt; No, you don&#x27;t.<p>This is correct. Most disk-oriented DBMSs use fixed-size pages. So you can&#x27;t go larger than the node size (not entirely true if using auxiliary data structures to buffer changes like an inefficient -epsilon tree).</div><br/></div></div></div></div></div></div><div id="38594888" class="c"><input type="checkbox" id="c-38594888" checked=""/><div class="controls bullet"><span class="by">travisjungroth</span><span>|</span><a href="#38595123">prev</a><span>|</span><a href="#38595145">next</a><span>|</span><label class="collapse" for="c-38594888">[-]</label><label class="expand" for="c-38594888">[1 more]</label></div><br/><div class="children"><div class="content">There’s something to generalize here. If you run out of X, split by X. This bug happens when you run out of <i>space</i>, but split by <i>count</i>. Author’s comment said he fixed it by splitting by size (space taken).</div><br/></div></div><div id="38595145" class="c"><input type="checkbox" id="c-38595145" checked=""/><div class="controls bullet"><span class="by">hyperman1</span><span>|</span><a href="#38594888">prev</a><span>|</span><a href="#38596069">next</a><span>|</span><label class="collapse" for="c-38595145">[-]</label><label class="expand" for="c-38595145">[1 more]</label></div><br/><div class="children"><div class="content">When I implemented this, long ago, I had a expanded page structure containing the old page plus the new key.  So it had more memory than 1 page.  Then the expanded page, when writing it back, becomes 2 pages if a split is needed.<p>I did it this way for a few reasons.  One was I could release old key pages after new pages were written, avoiding data loss in IO errors.  Second was key (prefix) compression became a lot more easy. I never realised it, but it avoids the trouble in both blog post too.<p>It comes with some copy overhead, unfortunately.</div><br/></div></div><div id="38596069" class="c"><input type="checkbox" id="c-38596069" checked=""/><div class="controls bullet"><span class="by">czipperz</span><span>|</span><a href="#38595145">prev</a><span>|</span><a href="#38594589">next</a><span>|</span><label class="collapse" for="c-38596069">[-]</label><label class="expand" for="c-38596069">[5 more]</label></div><br/><div class="children"><div class="content">Is this only relevant for string based btree implementations? Or is this more relevant for custom rolled btrees for a concrete set of types</div><br/><div id="38596174" class="c"><input type="checkbox" id="c-38596174" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#38596069">parent</a><span>|</span><a href="#38594589">next</a><span>|</span><label class="collapse" for="c-38596174">[-]</label><label class="expand" for="c-38596174">[4 more]</label></div><br/><div class="children"><div class="content">This kind of thing makes me <i>really</i> wish we lived in a world where languages&#x2F;libraries had first-class support for containers.<p>C++ at least tries but falls so far short.</div><br/><div id="38596300" class="c"><input type="checkbox" id="c-38596300" checked=""/><div class="controls bullet"><span class="by">DylanSp</span><span>|</span><a href="#38596069">root</a><span>|</span><a href="#38596174">parent</a><span>|</span><a href="#38594589">next</a><span>|</span><label class="collapse" for="c-38596300">[-]</label><label class="expand" for="c-38596300">[3 more]</label></div><br/><div class="children"><div class="content">What would that first-class support look like? Having more container types as language built-in?</div><br/><div id="38596496" class="c"><input type="checkbox" id="c-38596496" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#38596069">root</a><span>|</span><a href="#38596300">parent</a><span>|</span><a href="#38596391">next</a><span>|</span><label class="collapse" for="c-38596496">[-]</label><label class="expand" for="c-38596496">[1 more]</label></div><br/><div class="children"><div class="content">It&#x27;s not that the types need to be built-in, but that the compiler needs to <i>know</i> that a type supports an interface, and the library needs to take advantage appropriately.<p>For this particular case, key-based containers need to know if their key is a homogeneous sequence. But that&#x27;s actually slightly too restrictive - in particular, a fixed-size prefix of a different type isn&#x27;t actually any harder to optimize for, assuming the introspection API is good enough.<p>But for other things ... even &quot;just give me the list of fields that this class has&quot; involves containers. Implementing compare&#x2F;hash efficiently (with short-circuiting!) requires peeking <i>inside</i> the heterogeneous tuple. Writing a partial JSON-like object literal? That&#x27;s a container, and one with very common uses. Making a copy of an object with certain fields replaced? A container. Functions that take keyword arguments? A container which you would really like to propagate sanely. But most compilers that deal with such things don&#x27;t actually support the usual container APIs, often even lacking simple concatenation (speaking of which - what about compile-time duplicate key detection?).</div><br/></div></div><div id="38596391" class="c"><input type="checkbox" id="c-38596391" checked=""/><div class="controls bullet"><span class="by">Tyr42</span><span>|</span><a href="#38596069">root</a><span>|</span><a href="#38596300">parent</a><span>|</span><a href="#38596496">prev</a><span>|</span><a href="#38594589">next</a><span>|</span><label class="collapse" for="c-38596391">[-]</label><label class="expand" for="c-38596391">[1 more]</label></div><br/><div class="children"><div class="content">A functor typeclass?</div><br/></div></div></div></div></div></div></div></div><div id="38594589" class="c"><input type="checkbox" id="c-38594589" checked=""/><div class="controls bullet"><span class="by">mondobe</span><span>|</span><a href="#38596069">prev</a><span>|</span><a href="#38595766">next</a><span>|</span><label class="collapse" for="c-38594589">[-]</label><label class="expand" for="c-38594589">[9 more]</label></div><br/><div class="children"><div class="content">I&#x27;ve got a Data Structures and Algorithms final tomorrow, likely including a few 2-4 Tree problems... I will be forever grateful that we at least don&#x27;t have to implement them, just simulate them.</div><br/><div id="38597613" class="c"><input type="checkbox" id="c-38597613" checked=""/><div class="controls bullet"><span class="by">dgreensp</span><span>|</span><a href="#38594589">parent</a><span>|</span><a href="#38596497">next</a><span>|</span><label class="collapse" for="c-38597613">[-]</label><label class="expand" for="c-38597613">[1 more]</label></div><br/><div class="children"><div class="content">It really isn&#x27;t so big a deal; the author of this post is spreading fear, in a way.<p>For example, saying that you need &quot;real world data&quot; to catch &quot;edge cases&quot; like this... no, proper unit tests will do just fine.  Also, the problem of splitting different-sized keys in the way the author first tries to do does not strike me as a mistake anyone would fall into or that is hard to get out of.</div><br/></div></div><div id="38596497" class="c"><input type="checkbox" id="c-38596497" checked=""/><div class="controls bullet"><span class="by">vincent-manis</span><span>|</span><a href="#38594589">parent</a><span>|</span><a href="#38597613">prev</a><span>|</span><a href="#38594789">next</a><span>|</span><label class="collapse" for="c-38596497">[-]</label><label class="expand" for="c-38596497">[4 more]</label></div><br/><div class="children"><div class="content">Many years ago I taught a Data Structures course section where all the students were B+s or As. I gave them an assignment to do in-memory B-tree insertion and search. They mostly succeeded, though I had more than one paper handed in that was titled “The Assignment From Hell”.</div><br/><div id="38596721" class="c"><input type="checkbox" id="c-38596721" checked=""/><div class="controls bullet"><span class="by">tomcam</span><span>|</span><a href="#38594589">root</a><span>|</span><a href="#38596497">parent</a><span>|</span><a href="#38596917">next</a><span>|</span><label class="collapse" for="c-38596721">[-]</label><label class="expand" for="c-38596721">[2 more]</label></div><br/><div class="children"><div class="content">&gt; all the students were B+s or As<p>Or maybe<p>&gt; all the students were B+s or B*s<p>I&#x27;ll see myself out now</div><br/><div id="38596803" class="c"><input type="checkbox" id="c-38596803" checked=""/><div class="controls bullet"><span class="by">vincent-manis</span><span>|</span><a href="#38594589">root</a><span>|</span><a href="#38596721">parent</a><span>|</span><a href="#38596917">next</a><span>|</span><label class="collapse" for="c-38596803">[-]</label><label class="expand" for="c-38596803">[1 more]</label></div><br/><div class="children"><div class="content">You win!</div><br/></div></div></div></div><div id="38596917" class="c"><input type="checkbox" id="c-38596917" checked=""/><div class="controls bullet"><span class="by">airstrike</span><span>|</span><a href="#38594589">root</a><span>|</span><a href="#38596497">parent</a><span>|</span><a href="#38596721">prev</a><span>|</span><a href="#38594789">next</a><span>|</span><label class="collapse" for="c-38596917">[-]</label><label class="expand" for="c-38596917">[1 more]</label></div><br/><div class="children"><div class="content"><i>&gt; “The Assignment From Hell”</i><p>LOL! I love that<p>That one for me must have been pricing reverse exchangeable notes in R</div><br/></div></div></div></div><div id="38594789" class="c"><input type="checkbox" id="c-38594789" checked=""/><div class="controls bullet"><span class="by">airstrike</span><span>|</span><a href="#38594589">parent</a><span>|</span><a href="#38596497">prev</a><span>|</span><a href="#38596716">next</a><span>|</span><label class="collapse" for="c-38594789">[-]</label><label class="expand" for="c-38594789">[2 more]</label></div><br/><div class="children"><div class="content">just curious.. what language is it being taught in?</div><br/><div id="38595679" class="c"><input type="checkbox" id="c-38595679" checked=""/><div class="controls bullet"><span class="by">widforss</span><span>|</span><a href="#38594589">root</a><span>|</span><a href="#38594789">parent</a><span>|</span><a href="#38596716">next</a><span>|</span><label class="collapse" for="c-38595679">[-]</label><label class="expand" for="c-38595679">[1 more]</label></div><br/><div class="children"><div class="content">When I did it it wasn&#x27;t in any language. We just drawed the evolution of the trees on paper. I got my degree in 2021.</div><br/></div></div></div></div><div id="38596716" class="c"><input type="checkbox" id="c-38596716" checked=""/><div class="controls bullet"><span class="by">tomcam</span><span>|</span><a href="#38594589">parent</a><span>|</span><a href="#38594789">prev</a><span>|</span><a href="#38595766">next</a><span>|</span><label class="collapse" for="c-38596716">[-]</label><label class="expand" for="c-38596716">[1 more]</label></div><br/><div class="children"><div class="content">What? They&#x27;re fun to implement</div><br/></div></div></div></div><div id="38595766" class="c"><input type="checkbox" id="c-38595766" checked=""/><div class="controls bullet"><span class="by">NooneAtAll3</span><span>|</span><a href="#38594589">prev</a><span>|</span><a href="#38594767">next</a><span>|</span><label class="collapse" for="c-38595766">[-]</label><label class="expand" for="c-38595766">[2 more]</label></div><br/><div class="children"><div class="content">what&#x27;s the point of storing different sized keys together?</div><br/><div id="38596184" class="c"><input type="checkbox" id="c-38596184" checked=""/><div class="controls bullet"><span class="by">o11c</span><span>|</span><a href="#38595766">parent</a><span>|</span><a href="#38594767">next</a><span>|</span><label class="collapse" for="c-38596184">[-]</label><label class="expand" for="c-38596184">[1 more]</label></div><br/><div class="children"><div class="content">There are a lot of things you can do, e.g. factor out a common prefix. But even without that, this avoids doing extra indirections, which mean slow memory accesses.<p>The reason to use B-family trees over binary trees is to avoid said memory slowness in the first place.</div><br/></div></div></div></div><div id="38594767" class="c"><input type="checkbox" id="c-38594767" checked=""/><div class="controls bullet"><span class="by">waynesonfire</span><span>|</span><a href="#38595766">prev</a><span>|</span><label class="collapse" for="c-38594767">[-]</label><label class="expand" for="c-38594767">[4 more]</label></div><br/><div class="children"><div class="content">Uhh.... maybe dont roll your own data structure if such a basic issue is causing you havoc.</div><br/><div id="38595007" class="c"><input type="checkbox" id="c-38595007" checked=""/><div class="controls bullet"><span class="by">schneems</span><span>|</span><a href="#38594767">parent</a><span>|</span><a href="#38598122">next</a><span>|</span><label class="collapse" for="c-38595007">[-]</label><label class="expand" for="c-38595007">[1 more]</label></div><br/><div class="children"><div class="content">Maybe link to a resource for people to download a good implementation of that data structure. Maybe link to an article describing hot so implement this data structure correctly in depth. Maybe try finding some other way to add to the conversation instead of disparaging the author for sharing something they learned. Maybe don’t post anything at all if you don’t have something productive to say. Maybe use nonviolent-communication (NVC) techniques to say exactly what you just said, but without condescension or attack.</div><br/></div></div><div id="38598122" class="c"><input type="checkbox" id="c-38598122" checked=""/><div class="controls bullet"><span class="by">aidenn0</span><span>|</span><a href="#38594767">parent</a><span>|</span><a href="#38595007">prev</a><span>|</span><a href="#38594793">next</a><span>|</span><label class="collapse" for="c-38598122">[-]</label><label class="expand" for="c-38598122">[1 more]</label></div><br/><div class="children"><div class="content">Aside from the other replies, I should point out that two very capable programers had to implement this differently because the performance implications of a design decision are different depending on the working-set size.<p>For all but the most basic data structures, the variations are so many that rolling your own is often a good design choice.</div><br/></div></div><div id="38594793" class="c"><input type="checkbox" id="c-38594793" checked=""/><div class="controls bullet"><span class="by">travisjungroth</span><span>|</span><a href="#38594767">parent</a><span>|</span><a href="#38598122">prev</a><span>|</span><label class="collapse" for="c-38594793">[-]</label><label class="expand" for="c-38594793">[1 more]</label></div><br/><div class="children"><div class="content">This makes it sound like it’s the author’s fault or something. They’re pointing out a pretty subtle gotcha.</div><br/></div></div></div></div></div></div></div></div></div></body></html>