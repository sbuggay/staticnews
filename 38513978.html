<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1701680458663" as="style"/><link rel="stylesheet" href="styles.css?v=1701680458663"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://patmaddox.com/doc/trunk/www/2023-12-sh-relative-shell-script-includes-with-realpath-on-freebsd/">Relative shell script includes with realpath on FreeBSD</a> <span class="domain">(<a href="https://patmaddox.com">patmaddox.com</a>)</span></div><div class="subtext"><span>signa11</span> | <span>20 comments</span></div><br/><div><div id="38514624" class="c"><input type="checkbox" id="c-38514624" checked=""/><div class="controls bullet"><span class="by">jchw</span><span>|</span><a href="#38514160">next</a><span>|</span><label class="collapse" for="c-38514624">[-]</label><label class="expand" for="c-38514624">[1 more]</label></div><br/><div class="children"><div class="content">In addition to other details noted about escaping&#x2F;quoting and the portability of realpath, it&#x27;s important to realize that those paths <i>by default</i> are not relative to the invocation directory, they&#x27;re relative to the current working directory, which happens to be the current working directory of the parent process initially. Also, for a shell script it is <i>relatively</i> reliable to rely on $0, but not guaranteed by any means: for example, an obvious way to subvert this would be to pipe the content of the script into a shell, though there&#x27;s surely plenty of ways you can think of that this could be broken.</div><br/></div></div><div id="38514160" class="c"><input type="checkbox" id="c-38514160" checked=""/><div class="controls bullet"><span class="by">rurban</span><span>|</span><a href="#38514624">prev</a><span>|</span><a href="#38514645">next</a><span>|</span><label class="collapse" for="c-38514160">[-]</label><label class="expand" for="c-38514160">[5 more]</label></div><br/><div class="children"><div class="content">He is still missing the double quotes, paths may contain spaces</div><br/><div id="38514184" class="c"><input type="checkbox" id="c-38514184" checked=""/><div class="controls bullet"><span class="by">stouset</span><span>|</span><a href="#38514160">parent</a><span>|</span><a href="#38514502">next</a><span>|</span><label class="collapse" for="c-38514184">[-]</label><label class="expand" for="c-38514184">[3 more]</label></div><br/><div class="children"><div class="content">Yep.<p><pre><code>    LIB=&quot;$(dirname &quot;$(realpath &quot;$0&quot;)&quot;)&quot;
</code></pre>
It seems like overkill, but just get in the habit of quoting anything and everything.</div><br/><div id="38514614" class="c"><input type="checkbox" id="c-38514614" checked=""/><div class="controls bullet"><span class="by">js2</span><span>|</span><a href="#38514160">root</a><span>|</span><a href="#38514184">parent</a><span>|</span><a href="#38514502">next</a><span>|</span><label class="collapse" for="c-38514614">[-]</label><label class="expand" for="c-38514614">[2 more]</label></div><br/><div class="children"><div class="content">You can technically omit the double-quotes during a scalar variable assignment (as long as it&#x27;s not preceded by a modifier such as `export`), so the outermost quotes are not needed above.<p><a href="https:&#x2F;&#x2F;unix.stackexchange.com&#x2F;questions&#x2F;68694&#x2F;when-is-double-quoting-necessary" rel="nofollow noreferrer">https:&#x2F;&#x2F;unix.stackexchange.com&#x2F;questions&#x2F;68694&#x2F;when-is-doubl...</a><p>The extra quotes don&#x27;t hurt, but also: use shellcheck. It will tell you if you&#x27;ve omitted necessary quotes.</div><br/><div id="38515056" class="c"><input type="checkbox" id="c-38515056" checked=""/><div class="controls bullet"><span class="by">lloeki</span><span>|</span><a href="#38514160">root</a><span>|</span><a href="#38514614">parent</a><span>|</span><a href="#38514502">next</a><span>|</span><label class="collapse" for="c-38515056">[-]</label><label class="expand" for="c-38515056">[1 more]</label></div><br/><div class="children"><div class="content">&gt; The extra quotes don&#x27;t hurt<p>I have the habit of quoting everything, that way I don&#x27;t have to <i>think</i> about any corner case where I can skip quotes, and thus conversely never miss anything where I should quote.<p>I do the same with curly braces, that way I don&#x27;t have to think whether &quot;${foo_bar}&quot; or &quot;${foo}_bar&quot; was meant, and makes later adding or reading string manipulation (e.g &quot;${haystack&#x2F;needle&#x2F;replacement}&quot;) or arrays (e.g &quot;${foo[42]}&quot; or &quot;${foo[@]}&quot; that much more consistent: variable references are always bounded by ${} which makes code easier to scan.<p>I apply that to &quot;${1}&quot; and &quot;${@}&quot; too whenever possible, unfortunately bash 3.x doesn&#x27;t quite like that so it&#x27;s not always the case (I can&#x27;t decide which one I hate more: macOS for the refusal to either update bash or outright drop it and just have a plain posix sh + zsh, or GNU for the viral license move which is practically highly detrimental in that case).<p>I also often quote &quot;semantically&quot;, e.g:<p><pre><code>    PATH=&quot;&#x2F;some&#x2F;path&#x2F;${foo}&#x2F;bar&quot;:&quot;${PATH}&quot;
    &#x2F;some&#x2F;command --foo=&quot;${bar}&quot;</code></pre></div><br/></div></div></div></div></div></div><div id="38514502" class="c"><input type="checkbox" id="c-38514502" checked=""/><div class="controls bullet"><span class="by">iforgotpassword</span><span>|</span><a href="#38514160">parent</a><span>|</span><a href="#38514184">prev</a><span>|</span><a href="#38514645">next</a><span>|</span><label class="collapse" for="c-38514502">[-]</label><label class="expand" for="c-38514502">[1 more]</label></div><br/><div class="children"><div class="content">Yeah that made me really anxious while reading this. That&#x27;s the first thing I hammer into fresh hires and interns who are &quot;lucky&quot; enough to end up dealing with shell scripts.</div><br/></div></div></div></div><div id="38514645" class="c"><input type="checkbox" id="c-38514645" checked=""/><div class="controls bullet"><span class="by">AsthmaBoy</span><span>|</span><a href="#38514160">prev</a><span>|</span><a href="#38514146">next</a><span>|</span><label class="collapse" for="c-38514645">[-]</label><label class="expand" for="c-38514645">[1 more]</label></div><br/><div class="children"><div class="content">Wouldn&#x27;t<p><pre><code>  readlink -f $0
</code></pre>
work to get the actual location of the script, and from there get the base for relative scripts?</div><br/></div></div><div id="38514146" class="c"><input type="checkbox" id="c-38514146" checked=""/><div class="controls bullet"><span class="by">yjftsjthsd-h</span><span>|</span><a href="#38514645">prev</a><span>|</span><a href="#38514424">next</a><span>|</span><label class="collapse" for="c-38514146">[-]</label><label class="expand" for="c-38514146">[9 more]</label></div><br/><div class="children"><div class="content">That&#x27;s a portable sh solution, isn&#x27;t it? Like, yes, it does work on FreeBSD, but it isn&#x27;t exclusive</div><br/><div id="38514278" class="c"><input type="checkbox" id="c-38514278" checked=""/><div class="controls bullet"><span class="by">mhio</span><span>|</span><a href="#38514146">parent</a><span>|</span><a href="#38514230">next</a><span>|</span><label class="collapse" for="c-38514278">[-]</label><label class="expand" for="c-38514278">[2 more]</label></div><br/><div class="children"><div class="content">The portablest solution I have found is:<p><pre><code>    rundir=$(cd -P -- &quot;$(dirname -- &quot;$0&quot;)&quot; &amp;&amp; printf &#x27;%s\n&#x27; &quot;$(pwd -P)&quot;)</code></pre></div><br/><div id="38515060" class="c"><input type="checkbox" id="c-38515060" checked=""/><div class="controls bullet"><span class="by">HerrMonnezza</span><span>|</span><a href="#38514146">root</a><span>|</span><a href="#38514278">parent</a><span>|</span><a href="#38514230">next</a><span>|</span><label class="collapse" for="c-38515060">[-]</label><label class="expand" for="c-38515060">[1 more]</label></div><br/><div class="children"><div class="content">I&#x27;m curious: why the `printf &#x27;%s\n&#x27; &quot;$(pwd -P)&quot;` ? wouldn&#x27;t just `pwd -P` achieve the same?</div><br/></div></div></div></div><div id="38514230" class="c"><input type="checkbox" id="c-38514230" checked=""/><div class="controls bullet"><span class="by">racingmars</span><span>|</span><a href="#38514146">parent</a><span>|</span><a href="#38514278">prev</a><span>|</span><a href="#38514155">next</a><span>|</span><label class="collapse" for="c-38514230">[-]</label><label class="expand" for="c-38514230">[1 more]</label></div><br/><div class="children"><div class="content">I think the closest portable solution we have would be basename instead of realpath, but I don&#x27;t think that takes care of the symlink problem described in the article.</div><br/></div></div><div id="38514155" class="c"><input type="checkbox" id="c-38514155" checked=""/><div class="controls bullet"><span class="by">oefrha</span><span>|</span><a href="#38514146">parent</a><span>|</span><a href="#38514230">prev</a><span>|</span><a href="#38514424">next</a><span>|</span><label class="collapse" for="c-38514155">[-]</label><label class="expand" for="c-38514155">[5 more]</label></div><br/><div class="children"><div class="content">POSIX has no realpath(1), so no.</div><br/><div id="38514357" class="c"><input type="checkbox" id="c-38514357" checked=""/><div class="controls bullet"><span class="by">arp242</span><span>|</span><a href="#38514146">root</a><span>|</span><a href="#38514155">parent</a><span>|</span><a href="#38514305">next</a><span>|</span><label class="collapse" for="c-38514357">[-]</label><label class="expand" for="c-38514357">[1 more]</label></div><br/><div class="children"><div class="content">*Yet.<p>Will be added in the upcoming revision: <a href="https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=1457" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=1457</a><p>20 years ago it was a &quot;BSD thing&quot;, but it seems to be more wide-spread these days; even my Alpine busybox system has it. I&#x27;m sure there are some platforms without it, but there are also platforms without some POSIX tools – it&#x27;s never a guarantee.</div><br/></div></div><div id="38514305" class="c"><input type="checkbox" id="c-38514305" checked=""/><div class="controls bullet"><span class="by">pixelbeat__</span><span>|</span><a href="#38514146">root</a><span>|</span><a href="#38514155">parent</a><span>|</span><a href="#38514357">prev</a><span>|</span><a href="#38514424">next</a><span>|</span><label class="collapse" for="c-38514305">[-]</label><label class="expand" for="c-38514305">[3 more]</label></div><br/><div class="children"><div class="content">All the main platforms have realpath(1). It was added to GNU Linux over 10 years ago now, to aid portability, and be a more natural command to access this functionality than readlink(1)</div><br/><div id="38515069" class="c"><input type="checkbox" id="c-38515069" checked=""/><div class="controls bullet"><span class="by">inferiorhuman</span><span>|</span><a href="#38514146">root</a><span>|</span><a href="#38514305">parent</a><span>|</span><a href="#38514413">next</a><span>|</span><label class="collapse" for="c-38515069">[-]</label><label class="expand" for="c-38515069">[1 more]</label></div><br/><div class="children"><div class="content">Saw a comment on another site mention this, but NetBSD won&#x27;t get it until 10.0 (not yet released) and OpenBSD got it in 7.1 (released last year).  Of course I&#x27;m of the mindset that building complex shell scripts is simply an exercise in masochism so this all seems like a solution in search of a problem.</div><br/></div></div><div id="38514413" class="c"><input type="checkbox" id="c-38514413" checked=""/><div class="controls bullet"><span class="by">oefrha</span><span>|</span><a href="#38514146">root</a><span>|</span><a href="#38514305">parent</a><span>|</span><a href="#38515069">prev</a><span>|</span><a href="#38514424">next</a><span>|</span><label class="collapse" for="c-38514413">[-]</label><label class="expand" for="c-38514413">[1 more]</label></div><br/><div class="children"><div class="content">Not really. macOS until version 12 doesn’t have realpath(1), it was only added this year. You can’t rely on it for portable code.</div><br/></div></div></div></div></div></div></div></div><div id="38514424" class="c"><input type="checkbox" id="c-38514424" checked=""/><div class="controls bullet"><span class="by">netcoyote</span><span>|</span><a href="#38514146">prev</a><span>|</span><label class="collapse" for="c-38514424">[-]</label><label class="expand" for="c-38514424">[3 more]</label></div><br/><div class="children"><div class="content">Should use $BASH_SOURCE in place of $0 so it works in files that are sourced.<p>The incantation at the top of all my scripts, that I learned from other HN folks, is:<p><pre><code>  SCRIPT_DIR=&quot;$( cd &quot;$( dirname &quot;${BASH_SOURCE[0]}&quot; )&quot; &amp;&amp; pwd )&quot;
</code></pre>
And I guess throw a realpath in there too for symlinks, per TFA.</div><br/><div id="38514577" class="c"><input type="checkbox" id="c-38514577" checked=""/><div class="controls bullet"><span class="by">arp242</span><span>|</span><a href="#38514424">parent</a><span>|</span><a href="#38514573">next</a><span>|</span><label class="collapse" for="c-38514577">[-]</label><label class="expand" for="c-38514577">[1 more]</label></div><br/><div class="children"><div class="content">&#x2F;bin&#x2F;sh on FreeBSD isn&#x27;t bash.</div><br/></div></div><div id="38514573" class="c"><input type="checkbox" id="c-38514573" checked=""/><div class="controls bullet"><span class="by">js2</span><span>|</span><a href="#38514424">parent</a><span>|</span><a href="#38514577">prev</a><span>|</span><label class="collapse" for="c-38514573">[-]</label><label class="expand" for="c-38514573">[1 more]</label></div><br/><div class="children"><div class="content">You don&#x27;t need realpath. The `cd` into the directory + `pwd` is equivalent.<p>BASH_SOURCE[0] obviously only works with bash.</div><br/></div></div></div></div></div></div></div></div></div></body></html>