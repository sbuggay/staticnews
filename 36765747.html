<!DOCTYPE html><html lang="en"><head><title>Static News</title><meta charSet="utf-8"/><meta name="description" content="Static delayed Hacker News."/><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1d1f21"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="application-name" content="Static News"/><meta name="apple-mobile-web-app-title" content="Static News"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#1d1f21"/><link rel="preload" href="styles.css?v=1689670852196" as="style"/><link rel="stylesheet" href="styles.css?v=1689670852196"/></head><body><div id="container"><div id="inner"><header><a href="/">Static News</a><a href="/about">about</a></header><div id="content"><div><div id="title"><a href="https://sourceware.org/git/?p=glibc.git;a=commit;h=454a20c8756c9c1d55419153255fc7692b3d2199">Strlcpy and strlcat added to glibc 2.38</a> <span class="domain">(<a href="https://sourceware.org">sourceware.org</a>)</span></div><div class="subtext"><span>synergy20</span> | <span>60 comments</span></div><br/><div><div id="36768427" class="c"><input type="checkbox" id="c-36768427" checked=""/><div class="controls bullet"><span class="by">eatbitseveryday</span><span>|</span><a href="#36767982">next</a><span>|</span><label class="collapse" for="c-36768427">[-]</label><label class="expand" for="c-36768427">[3 more]</label></div><br/><div class="children"><div class="content">Linux uses strscpy. See [1] [2] [3]. The issues of concern are to always NUL-terminate, and to effectively know if the result was truncated.<p>Truncation can lead to big issues, especially if the string being composed refers to paths, device names, other resources, etc. For example you may truncate a path from &#x2F;foo&#x2F;bar&#x2F;baz to &#x2F;foo&#x2F;bar and inadvertently operate on other files. An API that makes this confusing is dangerous.<p>See the confused deputy problem description [4].<p>[1] <a href="https:&#x2F;&#x2F;mafford.com&#x2F;text&#x2F;the-many-ways-to-copy-a-string-in-c&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;mafford.com&#x2F;text&#x2F;the-many-ways-to-copy-a-string-in-c...</a><p>[2] <a href="https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;659214&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;lwn.net&#x2F;Articles&#x2F;659214&#x2F;</a><p>[3] <a href="https:&#x2F;&#x2F;docs.kernel.org&#x2F;core-api&#x2F;kernel-api.html#c.strscpy" rel="nofollow noreferrer">https:&#x2F;&#x2F;docs.kernel.org&#x2F;core-api&#x2F;kernel-api.html#c.strscpy</a><p>[4] <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Confused_deputy_proble" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Confused_deputy_proble</a></div><br/><div id="36769367" class="c"><input type="checkbox" id="c-36769367" checked=""/><div class="controls bullet"><span class="by">dchest</span><span>|</span><a href="#36768427">parent</a><span>|</span><a href="#36768971">next</a><span>|</span><label class="collapse" for="c-36769367">[-]</label><label class="expand" for="c-36769367">[1 more]</label></div><br/><div class="children"><div class="content">Here&#x27;s discussion on why strscpy shouldn&#x27;t be included in POSIX:<p><a href="https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=986" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=986</a> (scroll to 0002897)</div><br/></div></div><div id="36768971" class="c"><input type="checkbox" id="c-36768971" checked=""/><div class="controls bullet"><span class="by">askiiart</span><span>|</span><a href="#36768427">parent</a><span>|</span><a href="#36769367">prev</a><span>|</span><a href="#36767982">next</a><span>|</span><label class="collapse" for="c-36768971">[-]</label><label class="expand" for="c-36768971">[1 more]</label></div><br/><div class="children"><div class="content">Fixed Wikipedia link: <a href="https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Confused_deputy_problem" rel="nofollow noreferrer">https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Confused_deputy_problem</a></div><br/></div></div></div></div><div id="36767982" class="c"><input type="checkbox" id="c-36767982" checked=""/><div class="controls bullet"><span class="by">avar</span><span>|</span><a href="#36768427">prev</a><span>|</span><a href="#36769528">next</a><span>|</span><label class="collapse" for="c-36767982">[-]</label><label class="expand" for="c-36767982">[30 more]</label></div><br/><div class="children"><div class="content">As a bit of historical context:<p>&quot;This is horribly inefficient BSD crap.  Using these function only
leads to other errors.  Correct string handling means that you always
know how long your strings are and therefore you can you memcpy
(instead of strcpy).<p>Beside, those who are using strcat or variants deserved to be punished.&quot;<p>- Ulrich Drepper, around 23 years ago: <a href="https:&#x2F;&#x2F;sourceware.org&#x2F;legacy-ml&#x2F;libc-alpha&#x2F;2000-08&#x2F;msg00053.html" rel="nofollow noreferrer">https:&#x2F;&#x2F;sourceware.org&#x2F;legacy-ml&#x2F;libc-alpha&#x2F;2000-08&#x2F;msg00053...</a></div><br/><div id="36768073" class="c"><input type="checkbox" id="c-36768073" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#36767982">parent</a><span>|</span><a href="#36768145">next</a><span>|</span><label class="collapse" for="c-36768073">[-]</label><label class="expand" for="c-36768073">[11 more]</label></div><br/><div class="children"><div class="content">He is not wrong, is he? If you are using null terminated strings that&#x27;s the thing you need to fix.<p>I still support this addition. If you are doing methamphetamine with needle sharing you should stop methamphetamine, but distributing clean needles is still an improvement.</div><br/><div id="36768832" class="c"><input type="checkbox" id="c-36768832" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768073">parent</a><span>|</span><a href="#36768492">next</a><span>|</span><label class="collapse" for="c-36768832">[-]</label><label class="expand" for="c-36768832">[4 more]</label></div><br/><div class="children"><div class="content">Well, the wider problem then is using C.</div><br/><div id="36768945" class="c"><input type="checkbox" id="c-36768945" checked=""/><div class="controls bullet"><span class="by">flohofwoe</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768832">parent</a><span>|</span><a href="#36768866">next</a><span>|</span><label class="collapse" for="c-36768945">[-]</label><label class="expand" for="c-36768945">[2 more]</label></div><br/><div class="children"><div class="content">Pretty much all operating system APIs use C-style zero-terminated strings. So while C may be historically responsible for the problem, not using C doesn&#x27;t help much if you need to talk to OS APIs.</div><br/></div></div><div id="36768866" class="c"><input type="checkbox" id="c-36768866" checked=""/><div class="controls bullet"><span class="by">ricardo81</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768832">parent</a><span>|</span><a href="#36768945">prev</a><span>|</span><a href="#36768492">next</a><span>|</span><label class="collapse" for="c-36768866">[-]</label><label class="expand" for="c-36768866">[1 more]</label></div><br/><div class="children"><div class="content">As a user posting from a Linux machine, I disagree. Though it seems the &quot;don&#x27;t use C&quot; crowd often delegate the important decisions to somewheres else.<p>I guess the answer is &quot;some people&#x27;s C is good enough, but not yours&quot;</div><br/></div></div></div></div><div id="36768492" class="c"><input type="checkbox" id="c-36768492" checked=""/><div class="controls bullet"><span class="by">parasti</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768073">parent</a><span>|</span><a href="#36768832">prev</a><span>|</span><a href="#36768145">next</a><span>|</span><label class="collapse" for="c-36768492">[-]</label><label class="expand" for="c-36768492">[6 more]</label></div><br/><div class="children"><div class="content">What a crazy metaphor! You&#x27;re equating using zero terminated strings in C to doing drugs.</div><br/><div id="36768863" class="c"><input type="checkbox" id="c-36768863" checked=""/><div class="controls bullet"><span class="by">mort96</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768492">parent</a><span>|</span><a href="#36768562">next</a><span>|</span><label class="collapse" for="c-36768863">[-]</label><label class="expand" for="c-36768863">[1 more]</label></div><br/><div class="children"><div class="content">What&#x27;s up with people seeing an analogy and going &quot;you can&#x27;t equate those two things&quot;? Analogies aren&#x27;t equating things</div><br/></div></div><div id="36768562" class="c"><input type="checkbox" id="c-36768562" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768492">parent</a><span>|</span><a href="#36768863">prev</a><span>|</span><a href="#36768674">next</a><span>|</span><label class="collapse" for="c-36768562">[-]</label><label class="expand" for="c-36768562">[3 more]</label></div><br/><div class="children"><div class="content">I feel like the success rate of getting someone off of null terminated strings is probably lower than most rehabilitation programs.</div><br/><div id="36769034" class="c"><input type="checkbox" id="c-36769034" checked=""/><div class="controls bullet"><span class="by">IshKebab</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768562">parent</a><span>|</span><a href="#36768674">next</a><span>|</span><label class="collapse" for="c-36769034">[-]</label><label class="expand" for="c-36769034">[2 more]</label></div><br/><div class="children"><div class="content">We can&#x27;t entirely because of the C ABI but apart from that it&#x27;s as simple as not using C which is not too difficult. C is not a popular language these days.</div><br/><div id="36769309" class="c"><input type="checkbox" id="c-36769309" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36769034">parent</a><span>|</span><a href="#36768674">next</a><span>|</span><label class="collapse" for="c-36769309">[-]</label><label class="expand" for="c-36769309">[1 more]</label></div><br/><div class="children"><div class="content">“Apart from that” does a lot of work here: FFI layers generally talk nul-terminated string unless otherwise specified, so do syscalls.</div><br/></div></div></div></div></div></div><div id="36768674" class="c"><input type="checkbox" id="c-36768674" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768492">parent</a><span>|</span><a href="#36768562">prev</a><span>|</span><a href="#36768145">next</a><span>|</span><label class="collapse" for="c-36768674">[-]</label><label class="expand" for="c-36768674">[1 more]</label></div><br/><div class="children"><div class="content">I mean it’s a wash, on the one hand zero terminated strings have done untold amounts of damage[0] and are impossible to extirpate once they’re in, on the other hand the nazis were methed (and coked later on) up their eyeballs.<p>[0] and not just in C itself, unexpected truncation through FFI is an issue which regularly pops up</div><br/></div></div></div></div></div></div><div id="36768145" class="c"><input type="checkbox" id="c-36768145" checked=""/><div class="controls bullet"><span class="by">sillywalk</span><span>|</span><a href="#36767982">parent</a><span>|</span><a href="#36768073">prev</a><span>|</span><a href="#36769108">next</a><span>|</span><label class="collapse" for="c-36768145">[-]</label><label class="expand" for="c-36768145">[3 more]</label></div><br/><div class="children"><div class="content">-<i>edit</i>- I&#x27;m not a C programmer, nor do I have any opinion on whether  api is garbage or less worse or whatever.<p>They seemed useful enough to get added to the other BSDs, Solaris, Mac OS X, Irix(!), QNX, and Cygwin as well as used in the Linux kernel.</div><br/><div id="36768198" class="c"><input type="checkbox" id="c-36768198" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768145">parent</a><span>|</span><a href="#36768162">next</a><span>|</span><label class="collapse" for="c-36768198">[-]</label><label class="expand" for="c-36768198">[1 more]</label></div><br/><div class="children"><div class="content">Distributing clean needles is useful, yes, but you should still lament why it is necessary.</div><br/></div></div><div id="36768162" class="c"><input type="checkbox" id="c-36768162" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768145">parent</a><span>|</span><a href="#36768198">prev</a><span>|</span><a href="#36769108">next</a><span>|</span><label class="collapse" for="c-36768162">[-]</label><label class="expand" for="c-36768162">[1 more]</label></div><br/><div class="children"><div class="content">The Linux kernel has better options, notably strscpy.</div><br/></div></div></div></div><div id="36769108" class="c"><input type="checkbox" id="c-36769108" checked=""/><div class="controls bullet"><span class="by">a_bonobo</span><span>|</span><a href="#36767982">parent</a><span>|</span><a href="#36768145">prev</a><span>|</span><a href="#36768017">next</a><span>|</span><label class="collapse" for="c-36769108">[-]</label><label class="expand" for="c-36769108">[1 more]</label></div><br/><div class="children"><div class="content">HN discussion around this quote, around 12 years ago: <a href="https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=2378013">https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=2378013</a></div><br/></div></div><div id="36768017" class="c"><input type="checkbox" id="c-36768017" checked=""/><div class="controls bullet"><span class="by">chris_wot</span><span>|</span><a href="#36767982">parent</a><span>|</span><a href="#36769108">prev</a><span>|</span><a href="#36769528">next</a><span>|</span><label class="collapse" for="c-36768017">[-]</label><label class="expand" for="c-36768017">[14 more]</label></div><br/><div class="children"><div class="content">He was a jerk, but often he had a reason for his abusiveness. Was the reason in this case valid?</div><br/><div id="36768517" class="c"><input type="checkbox" id="c-36768517" checked=""/><div class="controls bullet"><span class="by">IvyMike</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768017">parent</a><span>|</span><a href="#36768763">next</a><span>|</span><label class="collapse" for="c-36768517">[-]</label><label class="expand" for="c-36768517">[5 more]</label></div><br/><div class="children"><div class="content">The question is: Is string truncation a good solution when the strings you have are unexpectedly long?  Like, it&#x27;s probably ok in a lot of cases, and once you start using these functions, it&#x27;s very tempting to use them almost everywhere... but truncating &quot;Attack at dawn on Friday&quot; to &quot;Attack at dawn&quot; could be a disaster as well.<p>On the other hand, his recommendation to always know string lengths and use memcpy didn&#x27;t really become common practice over the last 20+ years either, so I&#x27;m not sure it was worth all the arguing.<p>At this point, I&#x27;m kind of joining the camp of &quot;C has proven to be too bug-prone for most organizations to use safely and therefore we should all go to Rust&quot;.</div><br/><div id="36768941" class="c"><input type="checkbox" id="c-36768941" checked=""/><div class="controls bullet"><span class="by">radiator</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768517">parent</a><span>|</span><a href="#36768620">next</a><span>|</span><label class="collapse" for="c-36768941">[-]</label><label class="expand" for="c-36768941">[1 more]</label></div><br/><div class="children"><div class="content">The second part &quot;and therefore we should all go to Rust&quot; does not follow necessarily from the first. Maybe the reason not everybody is gone to Rust is that it lacks something. Maybe we will all go somewhere else.</div><br/></div></div><div id="36768620" class="c"><input type="checkbox" id="c-36768620" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768517">parent</a><span>|</span><a href="#36768941">prev</a><span>|</span><a href="#36768860">next</a><span>|</span><label class="collapse" for="c-36768620">[-]</label><label class="expand" for="c-36768620">[1 more]</label></div><br/><div class="children"><div class="content">I suspect the eventual end result is major compilers start implementing a &quot;fat pointer&quot; string ABI for internal translation units (decaying to char * at the edge where necessary) and people start turning that on.</div><br/></div></div><div id="36768860" class="c"><input type="checkbox" id="c-36768860" checked=""/><div class="controls bullet"><span class="by">eru</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768517">parent</a><span>|</span><a href="#36768620">prev</a><span>|</span><a href="#36768763">next</a><span>|</span><label class="collapse" for="c-36768860">[-]</label><label class="expand" for="c-36768860">[2 more]</label></div><br/><div class="children"><div class="content">&gt; On the other hand, his recommendation to always know string lengths and use memcpy didn&#x27;t really become common practice over the last 20+ years either, so I&#x27;m not sure it was worth all the arguing.<p>It hasn&#x27;t become common practice in C.  But other languages (like JavaScript or Python) have become hugely popular, and don&#x27;t use null-terminated strings.</div><br/><div id="36768961" class="c"><input type="checkbox" id="c-36768961" checked=""/><div class="controls bullet"><span class="by">tomjakubowski</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768860">parent</a><span>|</span><a href="#36768763">next</a><span>|</span><label class="collapse" for="c-36768961">[-]</label><label class="expand" for="c-36768961">[1 more]</label></div><br/><div class="children"><div class="content">Even languages in C&#x27;s niche encode strings as pointer + length, like Rust.</div><br/></div></div></div></div></div></div><div id="36768763" class="c"><input type="checkbox" id="c-36768763" checked=""/><div class="controls bullet"><span class="by">paulv</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768017">parent</a><span>|</span><a href="#36768517">prev</a><span>|</span><a href="#36768771">next</a><span>|</span><label class="collapse" for="c-36768763">[-]</label><label class="expand" for="c-36768763">[1 more]</label></div><br/><div class="children"><div class="content">&gt; but often he had a reason for his abusiveness<p>There is never, ever, under any circumstances, a reason to be abusive.</div><br/></div></div><div id="36768771" class="c"><input type="checkbox" id="c-36768771" checked=""/><div class="controls bullet"><span class="by">bufio</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768017">parent</a><span>|</span><a href="#36768763">prev</a><span>|</span><a href="#36768074">next</a><span>|</span><label class="collapse" for="c-36768771">[-]</label><label class="expand" for="c-36768771">[1 more]</label></div><br/><div class="children"><div class="content">No.</div><br/></div></div><div id="36768074" class="c"><input type="checkbox" id="c-36768074" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768017">parent</a><span>|</span><a href="#36768771">prev</a><span>|</span><a href="#36769528">next</a><span>|</span><label class="collapse" for="c-36768074">[-]</label><label class="expand" for="c-36768074">[6 more]</label></div><br/><div class="children"><div class="content">Yes.</div><br/><div id="36768114" class="c"><input type="checkbox" id="c-36768114" checked=""/><div class="controls bullet"><span class="by">pnpnp</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768074">parent</a><span>|</span><a href="#36769528">next</a><span>|</span><label class="collapse" for="c-36768114">[-]</label><label class="expand" for="c-36768114">[5 more]</label></div><br/><div class="children"><div class="content">Why?</div><br/><div id="36768176" class="c"><input type="checkbox" id="c-36768176" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768114">parent</a><span>|</span><a href="#36768146">next</a><span>|</span><label class="collapse" for="c-36768176">[-]</label><label class="expand" for="c-36768176">[3 more]</label></div><br/><div class="children"><div class="content">Inefficiency probably doesn&#x27;t need any comment (these functions traverse string twice instead of once). His argument that string length should be always known is correct in theory although not in practice.</div><br/><div id="36768543" class="c"><input type="checkbox" id="c-36768543" checked=""/><div class="controls bullet"><span class="by">tedunangst</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768176">parent</a><span>|</span><a href="#36768146">next</a><span>|</span><label class="collapse" for="c-36768543">[-]</label><label class="expand" for="c-36768543">[2 more]</label></div><br/><div class="children"><div class="content">Can you name a program that runs too slowly because it uses strlcpy?</div><br/><div id="36768596" class="c"><input type="checkbox" id="c-36768596" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768543">parent</a><span>|</span><a href="#36768146">next</a><span>|</span><label class="collapse" for="c-36768596">[-]</label><label class="expand" for="c-36768596">[1 more]</label></div><br/><div class="children"><div class="content">You&#x27;re looking at it wrong. strlcpy is defined to be slow in certain cases. The API <i>requires</i> it. Other interfaces may be slow today but can be improved in the future because they don&#x27;t have a return value that is inconvenient. (Notably, memccpy today is typically a memchr followed by memcpy, since this is faster than a naive implementation. Obviously if it gets used more then it will get replaced with a single-pass, machine optimized implementation.)</div><br/></div></div></div></div></div></div><div id="36768146" class="c"><input type="checkbox" id="c-36768146" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767982">root</a><span>|</span><a href="#36768114">parent</a><span>|</span><a href="#36768176">prev</a><span>|</span><a href="#36769528">next</a><span>|</span><label class="collapse" for="c-36768146">[-]</label><label class="expand" for="c-36768146">[1 more]</label></div><br/><div class="children"><div class="content">People typically do not realize that it has a return value that is expensive to compute.</div><br/></div></div></div></div></div></div></div></div></div></div><div id="36769528" class="c"><input type="checkbox" id="c-36769528" checked=""/><div class="controls bullet"><span class="by">t43562</span><span>|</span><a href="#36767982">prev</a><span>|</span><a href="#36767838">next</a><span>|</span><label class="collapse" for="c-36769528">[-]</label><label class="expand" for="c-36769528">[1 more]</label></div><br/><div class="children"><div class="content">NULL terminated strings are a fact of life in many cases and C just needs lots of string functions to cater for different use cases.   e.g. usually for me truncation is worse than crashing (corrupted data basically).<p>When I read arguments they are full of people thinking that their one size fits all and that somehow having too many variations would be bad.<p>This seems illogical to me since I&#x27;ve had to write my own string copying routines enough times because the one that fitted my need wasn&#x27;t commonly available.  Purism with C is just stu.... well anyhow.<p>A &quot;good&quot; fat pointer library for C would help a lot - something that could pop a NUL onto the end when you needed to put the string into an OS function but I would also have to groan at the idea that NUL termination should be outlawed in some way. At the C level you want options not limitations.</div><br/></div></div><div id="36767838" class="c"><input type="checkbox" id="c-36767838" checked=""/><div class="controls bullet"><span class="by">TazeTSchnitzel</span><span>|</span><a href="#36769528">prev</a><span>|</span><a href="#36768870">next</a><span>|</span><label class="collapse" for="c-36767838">[-]</label><label class="expand" for="c-36767838">[2 more]</label></div><br/><div class="children"><div class="content">If you ever find yourself writing strcpy() followed by strcat(), consider:<p><pre><code>  snprintf(buf, sizeof(buf), &quot;%s%s&quot;, a, b);
</code></pre>
This as safe as strlcpy and strlcat, but more efficient, and has been standard for 24 years.</div><br/><div id="36768138" class="c"><input type="checkbox" id="c-36768138" checked=""/><div class="controls bullet"><span class="by">saagarjha</span><span>|</span><a href="#36767838">parent</a><span>|</span><a href="#36768870">next</a><span>|</span><label class="collapse" for="c-36768138">[-]</label><label class="expand" for="c-36768138">[1 more]</label></div><br/><div class="children"><div class="content">1. This returns an int.<p>2. This is inefficient in a similar way that strlcpy is: it does more work than the size of the buffer.</div><br/></div></div></div></div><div id="36768870" class="c"><input type="checkbox" id="c-36768870" checked=""/><div class="controls bullet"><span class="by">zbuf</span><span>|</span><a href="#36767838">prev</a><span>|</span><a href="#36767223">next</a><span>|</span><label class="collapse" for="c-36768870">[-]</label><label class="expand" for="c-36768870">[1 more]</label></div><br/><div class="children"><div class="content">Interesting to see the implementation is basically a two-pass process: strlen() to count the source string, followed by a memcpy().<p>My intuition would be to give some importance to not looping on the source string radically beyond the length of the destination buffer.<p><a href="https:&#x2F;&#x2F;sourceware.org&#x2F;git&#x2F;?p=glibc.git;a=blob;f=string&#x2F;strlcpy.c;h=7a0df3ebb6b279cf151daf14a8cde3b43e705f6c;hb=454a20c8756c9c1d55419153255fc7692b3d2199" rel="nofollow noreferrer">https:&#x2F;&#x2F;sourceware.org&#x2F;git&#x2F;?p=glibc.git;a=blob;f=string&#x2F;strl...</a></div><br/></div></div><div id="36767223" class="c"><input type="checkbox" id="c-36767223" checked=""/><div class="controls bullet"><span class="by">sillywalk</span><span>|</span><a href="#36768870">prev</a><span>|</span><a href="#36769295">next</a><span>|</span><label class="collapse" for="c-36767223">[-]</label><label class="expand" for="c-36767223">[5 more]</label></div><br/><div class="children"><div class="content">It must be snowing in hell right now. :)<p>It says that they might be added to POSIX.<p><i>edit</i> apparently Ulrich Drepper (major glibc contributer &amp; former glibc leader is back at Red Hat [0]<p><a href="https:&#x2F;&#x2F;research.redhat.com&#x2F;blog&#x2F;project_member&#x2F;ulrich-drepper&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;research.redhat.com&#x2F;blog&#x2F;project_member&#x2F;ulrich-drepp...</a></div><br/><div id="36767478" class="c"><input type="checkbox" id="c-36767478" checked=""/><div class="controls bullet"><span class="by">wahern</span><span>|</span><a href="#36767223">parent</a><span>|</span><a href="#36768034">next</a><span>|</span><label class="collapse" for="c-36767478">[-]</label><label class="expand" for="c-36767478">[1 more]</label></div><br/><div class="children"><div class="content">They&#x27;re already in draft 3 of the forthcoming 202x revision. The glibc work resulted in a request to clarify the draft 3 specification: <a href="https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=1726" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.austingroupbugs.net&#x2F;view.php?id=1726</a></div><br/></div></div><div id="36768034" class="c"><input type="checkbox" id="c-36768034" checked=""/><div class="controls bullet"><span class="by">chris_wot</span><span>|</span><a href="#36767223">parent</a><span>|</span><a href="#36767478">prev</a><span>|</span><a href="#36769295">next</a><span>|</span><label class="collapse" for="c-36768034">[-]</label><label class="expand" for="c-36768034">[3 more]</label></div><br/><div class="children"><div class="content">I&#x27;ll bet he would be a laugh to work with.</div><br/><div id="36768076" class="c"><input type="checkbox" id="c-36768076" checked=""/><div class="controls bullet"><span class="by">sillywalk</span><span>|</span><a href="#36767223">root</a><span>|</span><a href="#36768034">parent</a><span>|</span><a href="#36769295">next</a><span>|</span><label class="collapse" for="c-36768076">[-]</label><label class="expand" for="c-36768076">[2 more]</label></div><br/><div class="children"><div class="content">Perhaps working at Goldman Sachs mellowed him out some.</div><br/><div id="36769554" class="c"><input type="checkbox" id="c-36769554" checked=""/><div class="controls bullet"><span class="by">dezgeg</span><span>|</span><a href="#36767223">root</a><span>|</span><a href="#36768076">parent</a><span>|</span><a href="#36769295">next</a><span>|</span><label class="collapse" for="c-36769554">[-]</label><label class="expand" for="c-36769554">[1 more]</label></div><br/><div class="children"><div class="content">I hope not, as entire reason he went there was to punish the bankers for their role in the 2008 financial crisis ;)<p>(<a href="https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;linux&#x2F;comments&#x2F;zzhd9&#x2F;comment&#x2F;c69camq&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;linux&#x2F;comments&#x2F;zzhd9&#x2F;comment&#x2F;c69cam...</a>)</div><br/></div></div></div></div></div></div></div></div><div id="36769295" class="c"><input type="checkbox" id="c-36769295" checked=""/><div class="controls bullet"><span class="by">hyperman1</span><span>|</span><a href="#36767223">prev</a><span>|</span><a href="#36767240">next</a><span>|</span><label class="collapse" for="c-36769295">[-]</label><label class="expand" for="c-36769295">[2 more]</label></div><br/><div class="children"><div class="content">I fear all of this is dancing around the nasty core of the problem:  generic writing to C style strings can&#x27;t be done without extra information.  You can&#x27;t write stuff to memory without negotiating how much room is needed and available, and optionally moving the string.  Silent truncation will cause bugs.  Buffer overflow even more.<p>Fixing this now is hard: Writing to 0-ended strings require manually tracking lengths.  Expanding a string without allowing malloc is misery.<p>The only way out I see is basically starting from zero: ISO C should define an API with a (pointer,current length, max length) struct at its core,  pointer pointing to a 0-terminated C string.  You can read it, but changing it requires using functions that can error out and&#x2F;or malloc more memory.  There are already multiple libs like this, but C has none. If the struct would be ABI, non-C programming languages can pass strings between them.</div><br/><div id="36769409" class="c"><input type="checkbox" id="c-36769409" checked=""/><div class="controls bullet"><span class="by">samtho</span><span>|</span><a href="#36769295">parent</a><span>|</span><a href="#36767240">next</a><span>|</span><label class="collapse" for="c-36769409">[-]</label><label class="expand" for="c-36769409">[1 more]</label></div><br/><div class="children"><div class="content">C had the opportunity to include this but they did not. It is my understanding that they wanted to design everything in C as inherent to the language, rather than magic types, especially a struct. There is an elegance in the notion that a string is <i>just</i> an array of characters. If I’m working with a significant amount of strings in C, I can keep track of lengths, not a huge deal.</div><br/></div></div></div></div><div id="36767240" class="c"><input type="checkbox" id="c-36767240" checked=""/><div class="controls bullet"><span class="by">Thoreandan</span><span>|</span><a href="#36769295">prev</a><span>|</span><a href="#36767769">next</a><span>|</span><label class="collapse" for="c-36767240">[-]</label><label class="expand" for="c-36767240">[1 more]</label></div><br/><div class="children"><div class="content">25 years on.  Congrats OpenBSD</div><br/></div></div><div id="36767769" class="c"><input type="checkbox" id="c-36767769" checked=""/><div class="controls bullet"><span class="by">panzi</span><span>|</span><a href="#36767240">prev</a><span>|</span><a href="#36769187">next</a><span>|</span><label class="collapse" for="c-36767769">[-]</label><label class="expand" for="c-36767769">[2 more]</label></div><br/><div class="children"><div class="content">What I&#x27;d like to have is snprintf_l(). It&#x27;s not standard, but it&#x27;s available in FreeBSD, macOS, and Windows (as _snprintf_l()). Just not in glibc (and probably musl).</div><br/><div id="36768339" class="c"><input type="checkbox" id="c-36768339" checked=""/><div class="controls bullet"><span class="by">jlokier</span><span>|</span><a href="#36767769">parent</a><span>|</span><a href="#36769187">next</a><span>|</span><label class="collapse" for="c-36768339">[-]</label><label class="expand" for="c-36768339">[1 more]</label></div><br/><div class="children"><div class="content">snprintf_l() is not standard, but you can simulate it with uselocale() to save and restore the per-thread locale, which is standard (POSIX.1-2008) and supported by Glibc, FreeBSD, MacOS and other OSes, though Windows requires its own, different way of doing per-thread locale.<p>It seems it was once an explicit design choice in Glibc.  Here (<a href="https:&#x2F;&#x2F;sourceware.org&#x2F;bugzilla&#x2F;show_bug.cgi?id=10891" rel="nofollow noreferrer">https:&#x2F;&#x2F;sourceware.org&#x2F;bugzilla&#x2F;show_bug.cgi?id=10891</a>) a Glibc ticket refers to documentation &quot;Thread-aware Local Model, A Proposal&quot; of the <i>plans</i> for the _l() functions (<a href="https:&#x2F;&#x2F;akkadia.org&#x2F;drepper&#x2F;tllocale.ps.gz" rel="nofollow noreferrer">https:&#x2F;&#x2F;akkadia.org&#x2F;drepper&#x2F;tllocale.ps.gz</a>) long ago, which are nowadays implemented in Glibc.<p>It looks like snprintf_l() and other &lt;stdio.h&gt; functions were not part of that plan.<p>That plan or something like it also made its way into POSIX.1-2008, so it seems likely that the committee gave some thought to including strftime_l() and not snprintf_l().<p>The paper linked above includes a rationale that tiny, potentially performance-critical functions like isalpha() need a fast version that takes a local parameter, thus isalpha_l(), because of the overhead of fetching a thread-local value inside the function.<p>Perhaps the intent is that only those tiny functions, or even macros, whose performance would be greatly affected by the cost of fetching the thread-local locale, need a _l() version.  That mostly makes sense for the functions which have _l() versions in Glibc.  But with that rationale, I don&#x27;t see why there is strftime_l() but not snprintf_l().</div><br/></div></div></div></div><div id="36769187" class="c"><input type="checkbox" id="c-36769187" checked=""/><div class="controls bullet"><span class="by">sirwhinesalot</span><span>|</span><a href="#36767769">prev</a><span>|</span><a href="#36768115">next</a><span>|</span><label class="collapse" for="c-36769187">[-]</label><label class="expand" for="c-36769187">[1 more]</label></div><br/><div class="children"><div class="content">Just make your own string functions from scratch when using C, you&#x27;ll thank me later.<p>First, you make two structs: str_buf { capacity, len, data[] } and str_view { len, data* }.<p>Then write your string handling functions to write into a str_buf* and read from str_views. You have the length and capacity available so memcpy is easy and safe to use.<p>The str_buf treats capacity as 1 less than it really is such that it can ensure there&#x27;s always a stupid 0 at the end for compatibility with APIs that expect 0 terminated strings.<p>There you go, no more security bugs, no more nonsense.</div><br/></div></div><div id="36768115" class="c"><input type="checkbox" id="c-36768115" checked=""/><div class="controls bullet"><span class="by">wyldfire</span><span>|</span><a href="#36769187">prev</a><span>|</span><a href="#36767292">next</a><span>|</span><label class="collapse" for="c-36768115">[-]</label><label class="expand" for="c-36768115">[8 more]</label></div><br/><div class="children"><div class="content">So was Drepper wrong?  Did he just get worn down?  Or did it not involve him at all?</div><br/><div id="36769534" class="c"><input type="checkbox" id="c-36769534" checked=""/><div class="controls bullet"><span class="by">fs111</span><span>|</span><a href="#36768115">parent</a><span>|</span><a href="#36768691">next</a><span>|</span><label class="collapse" for="c-36769534">[-]</label><label class="expand" for="c-36769534">[1 more]</label></div><br/><div class="children"><div class="content">I think he is doing other things these days <a href="https:&#x2F;&#x2F;research.redhat.com&#x2F;blog&#x2F;project_member&#x2F;ulrich-drepper&#x2F;" rel="nofollow noreferrer">https:&#x2F;&#x2F;research.redhat.com&#x2F;blog&#x2F;project_member&#x2F;ulrich-drepp...</a></div><br/></div></div><div id="36768691" class="c"><input type="checkbox" id="c-36768691" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#36768115">parent</a><span>|</span><a href="#36769534">prev</a><span>|</span><a href="#36768239">next</a><span>|</span><label class="collapse" for="c-36768691">[-]</label><label class="expand" for="c-36768691">[4 more]</label></div><br/><div class="children"><div class="content">I understand Drepper pretty much considers string.h a lost cause, and I can’t fault him for that.<p>It’s rather that POSIX decided to add the strl functions, so adding them (and verifying their semantics) is a necessity.</div><br/><div id="36769109" class="c"><input type="checkbox" id="c-36769109" checked=""/><div class="controls bullet"><span class="by">silon42</span><span>|</span><a href="#36768115">root</a><span>|</span><a href="#36768691">parent</a><span>|</span><a href="#36768239">next</a><span>|</span><label class="collapse" for="c-36769109">[-]</label><label class="expand" for="c-36769109">[3 more]</label></div><br/><div class="children"><div class="content">A purist would support removing strcpy, etc... but that wouldn&#x27;t go well, so adding an improvement is acceptable.</div><br/><div id="36769665" class="c"><input type="checkbox" id="c-36769665" checked=""/><div class="controls bullet"><span class="by">Gibbon1</span><span>|</span><a href="#36768115">root</a><span>|</span><a href="#36769109">parent</a><span>|</span><a href="#36769302">next</a><span>|</span><label class="collapse" for="c-36769665">[-]</label><label class="expand" for="c-36769665">[1 more]</label></div><br/><div class="children"><div class="content">They should have added a warning for strcpy 20 years ago and shipped the compiler with it default enabled.</div><br/></div></div><div id="36769302" class="c"><input type="checkbox" id="c-36769302" checked=""/><div class="controls bullet"><span class="by">masklinn</span><span>|</span><a href="#36768115">root</a><span>|</span><a href="#36769109">parent</a><span>|</span><a href="#36769665">prev</a><span>|</span><a href="#36768239">next</a><span>|</span><label class="collapse" for="c-36769302">[-]</label><label class="expand" for="c-36769302">[1 more]</label></div><br/><div class="children"><div class="content">&gt; A purist would support removing strcpy, etc...<p>That is very much Drepper’s position:<p>&gt; Correct string handling means that you always know how long your strings are and therefore you can you memcpy (instead of strcpy).<p>&gt; Beside, those who are using strcat or variants deserved to be punished.</div><br/></div></div></div></div></div></div><div id="36768239" class="c"><input type="checkbox" id="c-36768239" checked=""/><div class="controls bullet"><span class="by">sanxiyn</span><span>|</span><a href="#36768115">parent</a><span>|</span><a href="#36768691">prev</a><span>|</span><a href="#36769290">next</a><span>|</span><label class="collapse" for="c-36768239">[-]</label><label class="expand" for="c-36768239">[1 more]</label></div><br/><div class="children"><div class="content">I think the fact that it will be added to POSIX was decisive.</div><br/></div></div><div id="36769290" class="c"><input type="checkbox" id="c-36769290" checked=""/><div class="controls bullet"><span class="by">kzrdude</span><span>|</span><a href="#36768115">parent</a><span>|</span><a href="#36768239">prev</a><span>|</span><a href="#36767292">next</a><span>|</span><label class="collapse" for="c-36769290">[-]</label><label class="expand" for="c-36769290">[1 more]</label></div><br/><div class="children"><div class="content">He isn&#x27;t involved anymore, is he?</div><br/></div></div></div></div><div id="36767292" class="c"><input type="checkbox" id="c-36767292" checked=""/><div class="controls bullet"><span class="by">noobermin</span><span>|</span><a href="#36768115">prev</a><span>|</span><a href="#36768768">next</a><span>|</span><label class="collapse" for="c-36767292">[-]</label><label class="expand" for="c-36767292">[1 more]</label></div><br/><div class="children"><div class="content">The end of an era, a rather pedantic and overdrawn one.</div><br/></div></div><div id="36768768" class="c"><input type="checkbox" id="c-36768768" checked=""/><div class="controls bullet"><span class="by">10g1k</span><span>|</span><a href="#36767292">prev</a><span>|</span><a href="#36768740">next</a><span>|</span><label class="collapse" for="c-36768768">[-]</label><label class="expand" for="c-36768768">[1 more]</label></div><br/><div class="children"><div class="content">Abbreviations are just bad code.  Always.  Tradition is no excuse for writing bad code.  Names of everything should be sufficiently descriptive that absolutely anyone will know its purpose upon first glance.</div><br/></div></div><div id="36768740" class="c"><input type="checkbox" id="c-36768740" checked=""/><div class="controls bullet"><span class="by">psychphysic</span><span>|</span><a href="#36768768">prev</a><span>|</span><label class="collapse" for="c-36768740">[-]</label><label class="expand" for="c-36768740">[1 more]</label></div><br/><div class="children"><div class="content">Urgh more str functions.<p>I look forwards to forgetting about this and&#x2F;or discovering a new foot gun.</div><br/></div></div></div></div></div></div></div></body></html>